define(["./utils","text!./template/tab.html"],function(g,h){var e={tab:$(h).find("#tab-tpl").html(),iframe:$(h).find("#iframe-tpl").html()},i=0;var f={show:function(){},hide:function(){},destroy:function(){}};var c=function(l,o){var p=this,n,m,j=o.previousTab,s=o.closable,q=o.destroyable;n=g.getTplDom(e.tab,{nameCn:l.nameCn,menuId:l.id});m=g.getTplDom(e.iframe);p._tabDom=n;p._tabIframe=m;p.loaded=false;p._menu=l;if(j){p.setPrevious(j);j.setNext(p)}if(s){var k=m.children(".close").removeClass("hide");k.on("click",function(){p.destroy()})}n.on("click",function(){p.show()});n.on("mousedown",function(t){$("#"+l.id).contextmenu({target:"#context-menu",onItem:function(v,x){var u=$(x.target).text();var w=$(v).attr("id");if(u=="关闭当前页面"){p.destroy()}else{if(u=="关闭全部"){}else{if(u=="关闭其他页面"){}else{$.ajax({type:"POST",dataType:"json",data:{menuId:w},url:eastcom.baseURL+"/desktop/saveUserShortCut",success:function(y){g.showMsg("success",y.msg)},failure:function(){g.showMsg("danger","保存失败")}})}}}}})});var r=n.children(".close-btn");r.on("click",function(){p.destroy()});if(q==false){p.__destroyable=false}else{p.__destroyable=true}};var d=function(k){var j=k.find("iframe")[0];j.onload=function(){var l=this;eastcom.syncIframeHeight(l)}};var b=function(){var p=$(".head"),k=$("#tabs"),q=$("#foot"),l=$("#left-tree-cnt");var o=$(window).height(),m=p.outerHeight(),r=k.outerHeight(),j=q.outerHeight(),n=l.outerHeight();o-=m;o-=(k.is(":visible")?r:0);o-=(q.is(":visible")?j:0);i=o>n?o:n};var a=function(l,j){var k=l.find("iframe");k=k[0];k.src=j};$.extend(c.prototype,{show:function(){$("#tabs-iframe-cnt .tab-content").removeClass("active");$("#tabs li").removeClass("active");this._tabDom.addClass("active");this._tabIframe.addClass("active");if(!this.loaded){if(i==0){b();$(window).on("resize",b)}a(this._tabIframe,this._menu.location);d(this._tabIframe);this.loaded=true}this._tabIframe.find("iframe").css({"min-height":i});f.show(this);dynamicWidthForShow(this._menu)},hide:function(){var j=this.getPrevious();this._tabDom.removeClass("active");this._tabIframe.removeClass("active");j?j.show():[];f.hide(this)},destroy:function(){var m=this,l=m.getPrevious(),k=m.getNext();if(!m.destroyable()){return}var j=true;if(m._tabDom[0].className!=="active"){j=false}m._tabDom.remove();m._tabIframe.remove();if(l){l.setNext(k);if(j){l.show()}else{dynamicWidthForDestroy()}}if(k){k.setPrevious(l)}m.destroyed=true;f.destroy(this)},render:function(k,j){k.append(this._tabDom);j.append(this._tabIframe)},matchId:function(j){return this._menu.id===j},setLocation:function(j){a(this._tabIframe,j)},setPrevious:function(j){this.__prevoius=j},getPrevious:function(){return this.__prevoius},setNext:function(j){this.__next=j},getNext:function(){return this.__next},destroyable:function(){return this.__destroyable},isDestroyed:function(){return !!this.destroyed},getWindowObj:function(){var j=null;if(this._tabIframe){var k=this._tabIframe.children("iframe")[0];j=k.contentWindow}return j},callIframeFn:function(k,j){var m=this.getWindowObj();var l=m[k];if(l&&$.type(l)=="function"){l.apply(m,j)}}});c.create=function(k,j){return new c(k,j?j:{})};c.updateMinHeight=function(j){if(j>i){i=j;$("#tabs-iframe-cnt iframe").css({"min-height":i})}};c.setCallback=function(j,k){f[j]=k};return c});