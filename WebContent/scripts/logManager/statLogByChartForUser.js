Ext.ns("cis.repository.statLogByChart");Ext.Loader.setConfig({enabled:true});Ext.Loader.setPath("Ext.ux",extDir+"/ux");Ext.Loader.setPath("Ext.components",eastcom.baseURL+"/static/commonjs/components");Ext.require(["Ext.grid.*","Ext.data.*","Ext.ux.RowExpander","Ext.components.BaseDataComboBox","Ext.components.DateTimeField"]);var startString=Ext.util.Format.date(new Date(),"Y-m-d")+" 00:00:00";var endString=Ext.util.Format.date(new Date(),"Y-m-d H:i:s");var startTimeBox={xtype:"datetimefield",anchor:"100%",allowBlank:true,value:startString,width:150,name:"startTime",id:"startTime",timeConfig:{maxDate:"%y-%M-%d"}};var endTimeBox={id:"endTime",value:Ext.util.Format.date(new Date(),"Y-m-d H:i:s"),xtype:"datetimefield",allowBlank:true,width:150,name:"endTime",id:"endTime"};var userChooser=Ext.create("Ext.components.UserChooserField",{id:"user",name:"user",hiddenName:"user",submitValueField:"username",fieldLabel:USERNAME,editable:false,labelAlign:"right",emptyText:MSG_CHOOSE_ONE,width:300,listeners:{change:function(a){if(!userChooser.detailValue){deptChooser.enable()}else{deptChooser.disable()}}}});var deptChooser=Ext.create("Ext.components.DeptChooserField",{id:"dept",name:"dept",hiddenName:"dept",fieldLabel:DEPARTMENTS,submitValueField:"deptName",editable:false,labelAlign:"right",emptyText:MSG_CHOOSE_ONE,width:300,listeners:{change:function(a){if(!deptChooser.detailValue){userChooser.enable()}else{userChooser.disable()}}}});function statBtHandler(c,b,a,e,d){var f={dept:e,startTime:c,endTime:b,user:a};loadChartData(f);if(d){statByModulePlet.search(f);GeneralLogInfoCurvePlet.search(f);statByLoginPlet.search(f)}else{statByModulePlet.setParams(f);GeneralLogInfoCurvePlet.setParams(f);statByLoginPlet.setParams(f)}}function loadChartData(a){Ext.getBody().mask(MSG_DATA_LOADING);Ext.Ajax.request({url:eastcom.baseURL+"/extend/sysmng/queryChartData",method:"POST",timeout:300000,params:a,success:function(e,f){var b=Ext.JSON.decode(e.responseText);if(b.success=="true"){var c=b.data.module;var d=b.data.log;var g=b.data.times;renderChartData(c,"chart01Container","bar");renderChartData(g,"chart04Container","bar");renderChartData(d,"chart03Container","line")}else{}Ext.getBody().unmask()},failure:function(b,c){Ext.getBody().unmask()}})}function renderChartData(d,e,c){var b=function(h){var g=[];for(var f in h){g.push(h[f])}return g};var a=JSON.parse(d);require(["echarts","echarts/chart/bar","echarts/chart/line"],function(h){var f=h.init(document.getElementById(e),"macarons");var g={legend:{padding:5,itemGap:10,data:[a.lineName]},tooltip:{trigger:"item"},grid:{x:40,y:30,x2:20,y2:30},xAxis:[{type:"category",data:b(a.nameList)}],yAxis:[{type:"value",boundaryGap:[0,0.1],splitNumber:5}],series:[{name:a.lineName,type:c,data:b(a.valueList)}]};f.setOption(g)})}function mapShow(e,c,b,g,a,d){var f={loadStyle:"statByUser",startTime:e,endTime:c,user:b};Ext.Ajax.request({url:eastcom.baseURL+"/extend/sysmng/"+a,method:"POST",timeout:300000,params:f,success:function(h,i){var j=h.responseText;d.width="100%";d.height="100%";d.wMode="transparent";d.setData(j);d.write(g+"Container")},failure:function(h,i){}})}cis.repository.statLogByChart.QueryCondition=function(){var b=new Ext.Button({id:"statBt",text:BUTTON_STAT,style:"margin-left:20px",formBind:true,iconCls:"icon-search",width:70,minWidth:COMMONDATA_QUERY_BUTTON,handler:function(){if(Ext.getCmp("statConditionPl").form.isValid()){var f=Ext.getCmp("startTime").getValue();var d=Ext.getCmp("endTime").getValue();var h=userChooser.getSimpleUserNames();var c=[];if(!!deptChooser.detailValue){for(var e=0;e<deptChooser.detailValue.length;e++){c.push(deptChooser.detailValue[e]["id"])}}var g=c.join(",");if(f!=null&&f!=""&&d!=null&&d!=""){if(d<f){Ext.Msg.show({title:"提示",msg:"开始时间不能晚于结束时间",buttons:Ext.Msg.OK,icon:Ext.Msg.INFO});return false}statBtHandler(f,d,h.userNames.join(),g,true)}else{Ext.Msg.show({title:"提示",msg:"时间不能为空",buttons:Ext.Msg.OK,icon:Ext.Msg.INFO});return false}}}});var a=new Ext.Button({id:"reset",text:BUTTON_RESET,style:"margin-left:20px",formBind:true,iconCls:"icon-refresh",width:70,minWidth:COMMONDATA_QUERY_BUTTON,handler:function(){Ext.getCmp("startTime").setValue(startString);Ext.getCmp("endTime").setValue(endString);userChooser.reset("")}});cis.repository.statLogByChart.QueryCondition.superclass.constructor.call(this,{id:"statConditionPl",width:"100%",height:70,border:false,labelWidth:55,collapsible:IS_VISABLE,labelAlign:"right",region:"north",xtype:"form",items:[{xtype:"fieldcontainer",fieldLabel:"操作时间",labelWidth:80,labelAlign:"right",layout:"hbox",items:[startTimeBox,{xtype:"label",text:"-",margins:"0 10 0 10"},endTimeBox,deptChooser,userChooser,{xtype:"splitter"},b,a]}]})};Ext.extend(cis.repository.statLogByChart.QueryCondition,Ext.form.FormPanel,{});var portalHeight;var rowColumnHeight;var queryConditionPl;var statByModulePlet;var statByLoginPlet;var GeneralLogInfoCurvePlet;Ext.onReady(function(){Ext.QuickTips.init();queryConditionPl=new cis.repository.statLogByChart.QueryCondition();statByModulePlet=new cis.repository.statLogByChart.ChartByModulePlet();GeneralLogInfoCurvePlet=new cis.repository.statLogByChart.GeneralLogInfoCurvePlet();statByLoginPlet=new cis.repository.statLogByChart.ChartByLoginPlet();var a=new Ext.Viewport({layout:{type:"border",padding:5},items:[{region:"north",id:"conditionPanel",padding:"0 0 5 0",bodyPadding:10,width:"100%",height:50,collapsible:IS_VISABLE,layout:"fit",layoutConfig:{animate:true},items:[queryConditionPl]},{layout:"anchor",region:"center",border:false,id:"centerPanel",items:[{layout:"border",id:"northPanel",border:false,items:[{border:false,region:"west",width:"50%",margin:"0 5 5 0",layout:"fit",items:[statByModulePlet.getPanel()]},{border:false,layout:"fit",margin:"0 0 5 0",region:"center",items:[statByLoginPlet.getPanel()]}],anchor:"100% 50%"},{layout:"fit",border:false,items:[GeneralLogInfoCurvePlet.getPanel()],anchor:"100% 50%"}]}]});a.doLayout();var d=Ext.getCmp("startTime").getValue();var c=Ext.getCmp("endTime").getValue();var b=userChooser.getValue();var e=deptChooser.getValue();statBtHandler(d,c,b,e,false)});