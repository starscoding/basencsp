Ext.Loader.setConfig({enabled:true});Ext.Loader.setPath("Ext.ux",extDir+"/ux");Ext.Loader.setPath("Ext.components",eastcom.baseURL+"/static/commonjs/components");Ext.require(["Ext.grid.*","Ext.form.*","Ext.grid.property.*","Ext.data.*","Ext.ux.RowExpander","Ext.components.BaseDataComboBox","Ext.components.DateTimeField","Ext.components.ExportWin"]);eastcom.modules.sysLogStatistics=(function(){var h={};var g={};var f={};require.config({paths:{echarts:"http://echarts.baidu.com/build/dist"}});var q={qryUsingTimesUrl:eastcom.baseURL+"/sysmng/searchUsingTimes.do",qryVisistUsersUrl:eastcom.baseURL+"/sysmng/searchVisistUsers.do",qryLoginTimesUrl:eastcom.baseURL+"/sysmng/searchLoginTimes.do",exportSysLogStatisticsUrl:eastcom.baseURL+"/sysmng/exportSysLogStatistics.do",usingTimesChartUrl:eastcom.baseURL+"/sysmng/usingTimesChart.do",visistUsersChartUrl:eastcom.baseURL+"/sysmng/visistUsersChart.do",loginTimesChartUrl:eastcom.baseURL+"/sysmng/loginTimesChart.do"};var b={timeType:"D",userName:"",startTime:z("D",0,10),endTime:z("D",0,0),moduleCode:"",deptCode:""};var v=function(){var L=Ext.getCmp("userName").getValue();var O=Ext.getCmp("moduleCode").getValue();var N=Ext.getCmp("deptCode").getValue();var K;var M;if(Ext.getCmp("timeType").getValue()=="M"){K=F.getValue();M=G.getValue();K=K.replace("月","");K=K.replace("年","-");M=M.replace("月","");M=M.replace("年","-")}else{if(Ext.getCmp("timeType").getValue()=="D"){K=H.getValue();M=x.getValue()}else{K="";M=""}}param=Ext.apply(b,{timeType:Ext.getCmp("timeType").getValue(),userName:L,startTime:K,endTime:M,moduleCode:O,deptCode:N});return param};var t=Ext.create("Ext.form.ComboBox",{fieldLabel:"时间范围",id:"timeType",width:200,labelWidth:70,editable:false,labelAlign:"right",value:"D",store:{xtype:"store",fields:["value","name"],data:[{value:"D",name:"按日"},{value:"M",name:"按月"}]},queryMode:"local",displayField:"name",valueField:"value",listeners:{change:function(L,N,K,M){if(N==="M"){F.show();G.show()}else{F.hide().reset();G.hide().reset()}if(N==="D"){H.show();x.show()}else{H.hide().reset();x.hide().reset()}}}});function z(O,S,T){var L=new Date();L.setMonth(L.getMonth()-S);L.setDate(L.getDate()-T);var U=L.format("yyyyMMdd");var P=U.substring(0,4);var M=U.substring(4,6);var R=U.substring(6,8);var Q=P.toString();var K=M.toString();var N=R.toString();if(O=="M"){return t2=Q+"年"+K+"月"}else{if(O=="D"){return t2=Q+"-"+K+"-"+N}else{return""}}}var H=Ext.create("Ext.components.DateTimeField",{allowBlank:false,xtype:"datetimefield",fieldLabel:"开始日期",hidden:false,labelAlign:"right",labelWidth:60,value:z("D",0,10),width:200,name:"startDate",id:"startDate",endTimeField:{id:"endDate"},anchor:"95%",timeConfig:{maxDate:"%y-%M-%d",dateFmt:"yyyy-MM-dd"}});var x=Ext.create("Ext.components.DateTimeField",{allowBlank:false,xtype:"datetimefield",fieldLabel:"结束日期",hidden:false,labelAlign:"right",labelWidth:60,value:z("D",0,0),width:200,name:"endDate",id:"endDate",startTimeField:{id:"startDate"},anchor:"95%",timeConfig:{maxDate:"%y-%M-%d",dateFmt:"yyyy-MM-dd"}});var F=Ext.create("Ext.components.DateTimeField",{fieldLabel:"开始月份",width:200,labelWidth:60,labelAlign:"right",id:"startMonth",endTimeField:{id:"endMonth"},value:z("M",3,0),timeConfig:{isShowClear:false,dateFmt:"yyyy年MM月"},allowBlank:false,hidden:true,anchor:"95%"});var G=Ext.create("Ext.components.DateTimeField",{fieldLabel:"结束月份",width:200,labelWidth:60,labelAlign:"right",id:"endMonth",startTimeField:{id:"startMonth"},value:z("M",0,0),timeConfig:{maxDate:"%y-%M",isShowClear:false,dateFmt:"yyyy年MM月"},allowBlank:false,hidden:true,anchor:"95%"});function E(R,Q){var N=[];var P=[];var M="";var K="";if(Q=="1"){for(var L in R){N.push(R[L]["countUsingTimes"]);P.push(R[L]["moduleName"])}K="使用次数";M="bar"}else{if(Q=="2"){for(var L in R){N.push(R[L]["sysVisistUsers"]);P.push(R[L]["timeId_v"])}K="访问用户";M="line"}else{if(Q=="3"){for(var L in R){N.push(R[L]["sysVisistTimes"]);P.push(R[L]["timeId_l"])}M="line";K="登入次数"}}}var O={tooltip:{show:true},legend:{data:[K]},calculable:true,xAxis:[{type:"category",data:P}],yAxis:[{type:"value"}],series:[{name:K,type:M,data:N,itemStyle:{normal:{lineStyle:{type:"solid"},color:"#62bdff"}}}]};return O}function A(M,K,L){require(["echarts","echarts/theme/macarons","echarts/chart/bar","echarts/chart/line"],function(O,P){var N=O.init(document.getElementById(M),P);N.setOption(K)})}function p(L,K,O,M){var N=O||v();Ext.Ajax.request({url:K,method:"POST",params:N,disableCaching:true,success:function(P){var R=Ext.decode(P.responseText);var Q=E(R.data,M);if(M=="1"){h=Q}else{if(M=="2"){g=Q}else{if(M=="3"){f=Q}}}var S=L||"chartLeft";A(S,Q,M)},failure:function(P,Q){Ext.MessageBox.alert("提示消息","请求失败，请重试");Ext.Msg.show({title:"提示消息",msg:"请求失败，请重试",buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}})}var I=function(N,K,M){var L=M||v();Ext.Ajax.request({url:K,method:"POST",params:L,disableCaching:true,success:function(O){var P=O.responseText;C(P,N)},failure:function(O,P){Ext.MessageBox.alert("提示消息","请求失败，请重试");Ext.Msg.show({title:"提示消息",msg:"请求失败，请重试",buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}})};var C=function(K,M){var L=new AnyChart(jslib+"/anychart/AnyChart.swf",jslib+"/anychart/Preloader.swf");L.width="100%";L.height="100%";L.wMode="transparent";L.setData(K);L.write(M)};var l="";var k=function(P,K){var M=(P=="all");var N=q.exportSysLogStatisticsUrl+"?queryTotal="+M+"&fileType="+K;var L=null;if(l=="usingTimes"){L=Ext.getCmp("pageBar").getStore()}else{if(l=="visistUsers"){L=Ext.getCmp("pageBar_v").getStore()}else{if(l=="loginTimes"){L=Ext.getCmp("pageBar_l").getStore()}else{return}}}var Q=L.proxy.extraParams;if(Q!=null){for(var O in Q){N+=("&"+O+"="+Q[O])}}if(!M){if(s&&s.fromRecord){N+=("&start="+(s.fromRecord-1)+"&limit="+eastcom.pageSize)}else{N+=("&start=0&limit="+eastcom.pageSize)}}N+="&tableType="+l;window.open(encodeURI(N))};var D=Ext.create("Ext.components.ExportWin",{doExport:function(L,K){k(L,K)},getTotal:function(){if(s){return s.total}else{return 0}}});var n=[{header:"统计时间",dataIndex:"timeId",align:"center",width:"30%"},{header:"模块名称",dataIndex:"moduleName",align:"center",width:"30%"},{header:"使用次数(次)",dataIndex:"usingTimes",align:"center",width:"20%"},{header:"使用人数",dataIndex:"userCount",align:"center",width:"20%"}];var s=null;var a=Ext.create("Ext.data.Store",{fields:[{name:"timeId",type:"string"},{name:"moduleName",type:"string"},{name:"usingTimes",type:"string"},{name:"userCount",type:"string"}],pageSize:eastcom.pageSize,autoLoad:true,proxy:{type:"ajax",url:q.qryUsingTimesUrl,extraParams:b,reader:{type:"json",root:"data.elements",totalProperty:"data.total"},actionMethods:{read:"POST"},timeout:180000},listeners:{load:function(L,K,N,M){s={total:K.length}}}});var i=Ext.create("Ext.form.Panel",{region:"center",id:"usingTimes",layout:"card",activeItem:0,title:"使用次数",items:[{xtype:"panel",tbar:["使用次数统计",{xtype:"tbfill"},"-",{icon:"../../static/images/default/chart_bar.png",tooltip:"查看图表",handler:function(){A("usingTimesChart",h,"1");Ext.getCmp("usingTimes").getLayout().setActiveItem(0)}},"-",{icon:"../../static/images/default/data_list_num.png",tooltip:"查看表格数据",handler:function(){Ext.getCmp("usingTimes").getLayout().setActiveItem(1)}}],border:false,layout:{type:"hbox",align:"stretch"},items:[{id:"usingTimesChartPanel",flex:1,border:0,html:"<div id ='usingTimesChart' style='height:100%' ></div>"}]},{xtype:"gridpanel",border:false,layout:"fit",id:"usingTimesGrid",forceFit:true,store:a,columns:n,tbar:["使用次数统计",{xtype:"tbfill"},"-",{iconCls:"icon-xls",text:BUTTON_EXPORT,handler:function(){l="usingTimes";D.show()}},"-",{icon:"../../static/images/default/chart_bar.png",tooltip:"查看图表",handler:function(){Ext.getCmp("usingTimes").getLayout().setActiveItem(0);A("usingTimesChart",h,"1")}},"-",{icon:"../../static/images/default/data_list_num.png",tooltip:"查看表格数据",handler:function(){Ext.getCmp("usingTimes").getLayout().setActiveItem(1)}}],bbar:Ext.create("Ext.PagingToolbar",{id:"pageBar",store:a,displayInfo:true,listeners:{change:function(L,K){s=K}}})}]});var m=Ext.create("Ext.form.Panel",{layout:"border",title:"使用次数",items:[{region:"north",tbar:[{text:"图表",height:22}],margin:5,layout:{type:"hbox",align:"stretch"},height:250,items:[{id:"usingTimesChartPanel",flex:1,border:0,html:"<div id ='usingTimesChart' style='height:100%' ></div>"}]},{xtype:"gridpanel",flex:1,region:"center",margin:"0 5 5 5",layout:"fit",id:"usingTimesGrid",forceFit:true,store:a,columns:n,tbar:["详细信息","->",{iconCls:"icon-xls",text:BUTTON_EXPORT,handler:function(){l="usingTimes";D.show()}}],bbar:Ext.create("Ext.PagingToolbar",{id:"pageBar",store:a,displayInfo:true,listeners:{change:function(L,K){s=K}}})}]});var o=[{header:"统计时间",dataIndex:"timeId_v",align:"center",width:"50%"},{header:"系统访问去重用户数(个)",dataIndex:"sysVisistUsers",align:"center",width:"50%"}];var J=null;var w=Ext.create("Ext.data.Store",{fields:[{name:"timeId_v",type:"string"},{name:"sysVisistUsers",type:"string"}],pageSize:eastcom.pageSize,autoLoad:true,proxy:{type:"ajax",url:q.qryVisistUsersUrl,extraParams:b,reader:{type:"json",root:"data.elements",totalProperty:"data.total"},actionMethods:{read:"POST"},timeout:180000},listeners:{load:function(L,K,N,M){J={total:K.length}}}});var B=Ext.create("Ext.form.Panel",{region:"center",id:"visistUsers",layout:"card",activeItem:0,title:"访问用户",items:[{xtype:"panel",tbar:["访问用户统计",{xtype:"tbfill"},"-",{icon:"../../static/images/default/chart_bar.png",tooltip:"查看图表",handler:function(){A("visistUsersChart",g,"2");Ext.getCmp("visistUsers").getLayout().setActiveItem(0)}},"-",{icon:"../../static/images/default/data_list_num.png",tooltip:"查看表格数据",handler:function(){Ext.getCmp("visistUsers").getLayout().setActiveItem(1)}}],border:false,layout:{type:"hbox",align:"stretch"},items:[{id:"visistUsersChartPanel",border:0,flex:1,html:"<div id ='visistUsersChart' style='height:100%' ></div>"}]},{xtype:"gridpanel",border:false,layout:"fit",id:"visistUsersGrid",forceFit:true,store:w,columns:o,tbar:["访问用户统计",{xtype:"tbfill"},"-",{iconCls:"icon-xls",text:BUTTON_EXPORT,handler:function(){l="visistUsers";D.show()}},"-",{icon:"../../static/images/default/chart_bar.png",tooltip:"查看图表",handler:function(){Ext.getCmp("visistUsers").getLayout().setActiveItem(0);A("visistUsersChart",g,"2")}},"-",{icon:"../../static/images/default/data_list_num.png",tooltip:"查看表格数据",handler:function(){Ext.getCmp("visistUsers").getLayout().setActiveItem(1)}}],bbar:Ext.create("Ext.PagingToolbar",{id:"pageBar_v",store:w,displayInfo:true,listeners:{change:function(L,K){s=K}}})}]});var u=Ext.create("Ext.form.Panel",{layout:"border",title:"访问用户",items:[{region:"north",tbar:[{text:"图表",height:22}],margin:"5",layout:{type:"hbox",align:"stretch"},height:250,items:[{id:"visistUsersChartPanel",border:0,flex:1,html:"<div id ='visistUsersChart' style='height:100%' ></div>"}]},{xtype:"gridpanel",flex:1,region:"center",margin:"0 5 5 5",layout:"fit",id:"visistUsersGrid",forceFit:true,store:w,columns:o,tbar:["详细信息","->",{iconCls:"icon-xls",text:BUTTON_EXPORT,handler:function(){l="visistUsers";D.show()}}],bbar:Ext.create("Ext.PagingToolbar",{id:"pageBar_v",store:w,displayInfo:true,listeners:{change:function(L,K){J=K}}})}]});var r=[{header:"统计时间",dataIndex:"timeId_l",align:"center",width:"50%"},{header:"系统访问次数(次)",dataIndex:"sysVisistTimes",align:"center",width:"50%"}];var d=null;var y=Ext.create("Ext.data.Store",{fields:[{name:"timeId_l",type:"string"},{name:"sysVisistTimes",type:"string"}],pageSize:eastcom.pageSize,autoLoad:true,proxy:{type:"ajax",url:q.qryLoginTimesUrl,extraParams:b,reader:{type:"json",root:"data.elements",totalProperty:"data.total"},actionMethods:{read:"POST"},timeout:180000},listeners:{load:function(L,K,N,M){d={total:K.length}}}});var j=Ext.create("Ext.form.Panel",{region:"center",id:"loginTimes",layout:"card",activeItem:0,title:"登陆次数",items:[{xtype:"panel",tbar:["登陆次数统计",{xtype:"tbfill"},"-",{icon:"../../static/images/default/chart_bar.png",tooltip:"查看图表",handler:function(){A("loginTimesChart",f,"3");Ext.getCmp("loginTimes").getLayout().setActiveItem(0)}},"-",{icon:"../../static/images/default/data_list_num.png",tooltip:"查看表格数据",handler:function(){Ext.getCmp("loginTimes").getLayout().setActiveItem(1)}}],border:false,layout:{type:"hbox",align:"stretch"},items:[{id:"loginTimesChartPanel",flex:1,border:0,html:"<div id ='loginTimesChart' style='height:100%' ></div>"}]},{xtype:"gridpanel",border:false,layout:"fit",id:"loginTimesGrid",forceFit:true,store:y,columns:r,tbar:["使用次数统计",{xtype:"tbfill"},"-",{iconCls:"icon-xls",text:BUTTON_EXPORT,handler:function(){l="loginTimes";D.show()}},"-",{icon:"../../static/images/default/chart_bar.png",tooltip:"查看图表",handler:function(){Ext.getCmp("loginTimes").getLayout().setActiveItem(0);A("loginTimesChart",f,"3")}},"-",{icon:"../../static/images/default/data_list_num.png",tooltip:"查看表格数据",handler:function(){Ext.getCmp("loginTimes").getLayout().setActiveItem(1)}}],bbar:Ext.create("Ext.PagingToolbar",{id:"pageBar_l",store:y,displayInfo:true,listeners:{change:function(L,K){s=K}}})}]});var e=Ext.create("Ext.form.Panel",{layout:"border",title:"登陆次数",items:[{region:"north",tbar:[{text:"图表",height:22}],margin:"5",layout:{type:"hbox",align:"stretch"},height:250,items:[{id:"loginTimesChartPanel",flex:1,border:0,html:"<div id ='loginTimesChart' style='height:100%' ></div>"}]},{xtype:"gridpanel",flex:1,region:"center",margin:"0 5 5 5",layout:"fit",id:"loginTimesGrid",forceFit:true,store:y,columns:r,tbar:["详细信息","->",{iconCls:"icon-xls",text:BUTTON_EXPORT,handler:function(){l="loginTimes";D.show()}}],bbar:Ext.create("Ext.PagingToolbar",{id:"pageBar_l",store:y,displayInfo:true,listeners:{change:function(L,K){d=K}}})}]});function c(){Ext.create("Ext.Viewport",{layout:{type:"border"},padding:"5 5 5 5",defaults:{},items:[{region:"north",xtype:"panel",layout:"form",bodyPadding:10,margin:"0 0 5 0",defaults:{},items:[{xtype:"fieldcontainer",layout:"hbox",items:[t,H,F,x,G,{xtype:"button",style:"margin-left:20px",id:"search",text:"查询",iconCls:"icon-search",handler:function(K,M){var L=v();a.proxy.extraParams=L;Ext.getCmp("usingTimesGrid").reconfigure(a,n);Ext.getCmp("pageBar").bindStore(a);Ext.getCmp("pageBar").getStore().loadPage(1,{});Ext.getCmp("usingTimesGrid").doLayout();w.proxy.extraParams=L;Ext.getCmp("visistUsersGrid").reconfigure(w,o);Ext.getCmp("pageBar_v").bindStore(w);Ext.getCmp("pageBar_v").getStore().loadPage(1,{});Ext.getCmp("visistUsersGrid").doLayout();y.proxy.extraParams=L;Ext.getCmp("loginTimesGrid").reconfigure(y,r);Ext.getCmp("pageBar_l").bindStore(y);Ext.getCmp("pageBar_l").getStore().loadPage(1,{});Ext.getCmp("loginTimesGrid").doLayout();p("usingTimesChart",q.usingTimesChartUrl,L,"1");p("visistUsersChart",q.visistUsersChartUrl,L,"2");p("loginTimesChart",q.loginTimesChartUrl,L,"3")}},{xtype:"button",style:"margin-left:20px",id:"reset",text:"重置",iconCls:"icon-refresh",handler:function(K){t.setValue("D");H.setValue(z("D",0,10));x.setValue(z("D",0,0));Ext.getCmp("userName").reset("");Ext.getCmp("moduleCode").reset("");Ext.getCmp("deptCode").reset("")}}]},{xtype:"fieldset",checkboxToggle:true,collapsed:true,title:MSG_MORE_CONDITION,layout:"column",autoScroll:true,defaults:{layout:"anchor",defaults:{anchor:"100%",labelAlign:"right"}},items:[{columnWidth:1/3,defaultType:"textfield",baseCls:"x-plain",items:Ext.create("Ext.components.UserChooserField",{id:"userName",name:"useName",hiddenName:"userName",submitValueField:"userName",fieldLabel:USERNAME,editable:false,labelAlign:"right",emptyText:MSG_CHOOSE_ONE,labelWidth:70,width:300})},{columnWidth:1/3,defaultType:"textfield",baseCls:"x-plain",items:Ext.create("Ext.components.DeptChooserField",{id:"deptCode",fieldLabel:"部门选择",editable:false,labelAlign:"right",emptyText:MSG_CHOOSE_ONE})},{columnWidth:1/3,defaultType:"textfield",baseCls:"x-plain",items:Ext.create("Ext.components.ModuleChooserField",{id:"moduleCode",fieldLabel:"模块选择",editable:false,labelAlign:"right",emptyText:MSG_CHOOSE_ONE})}]}]},{region:"center",xtype:"tabpanel",id:"sysLogStatisticsTab",items:[i,B,j]}]});Ext.getCmp("sysLogStatisticsTab").setActiveTab(2);Ext.getCmp("sysLogStatisticsTab").setActiveTab(1);Ext.getCmp("sysLogStatisticsTab").setActiveTab(0);p("usingTimesChart",q.usingTimesChartUrl,null,"1");p("visistUsersChart",q.visistUsersChartUrl,null,"2");p("loginTimesChart",q.loginTimesChartUrl,null,"3");Ext.getCmp("usingTimesGrid").doLayout();Ext.getCmp("sysLogStatisticsTab").on("tabchange",function(L,K){if(K.title=="使用次数"){Ext.getCmp("moduleCode").setVisible(true);A("usingTimesChart",h,"1")}if(K.title=="访问用户"){Ext.getCmp("moduleCode").setVisible(false);A("visistUsersChart",g,"2")}if(K.title=="登陆次数"){Ext.getCmp("moduleCode").setVisible(false);A("loginTimesChart",f,"3")}})}return{initComponent:c}})();Ext.onReady(function(){Ext.QuickTips.init();eastcom.modules.sysLogStatistics.initComponent()});