var GadgetsWin=function(c){var l=this;var i=c;var k=[];var d=true;var g={width:620,height:280,title:"工具",closeAction:"hide",content:""};var h=function(o){var n=null;for(var m=0;m<k.length;m++){if(k[m].id==o){n=k[m];break}else{continue}}return n};var f=function(r){Ext.get(l.getBody()[0]).mask(MSG_DATA_SAVING);var m=Ext.getCmp(i);var n=m.findShortestCol();var o=h(r);var p={addConf:true,portalId:i,gadgetsId:r,height:o.defaultHeight,columnNumber:n.columnNumber,positionSeq:n.items.length};var q=function(w){var s=o.classUrl;var x=o.className;o.id=w;o.gadgets={classUrl:s,className:x};o.height=o.defaultHeight;var t=eastcom.baseURL+s;var B=new Number(o.defaultHeight);var A=x.substr(0,x.lastIndexOf("."));Ext.Loader.setPath(A,t);var y=Ext.create(x,{id:w,title:o.name,currentPortalId:i,height:B+1-1,columnNumber:n.columnNumber});n.add(y);n.totalHeight+=B;$("#"+r).remove();Ext.get(l.getBody()[0]).unmask();var C=Ext.getCmp("app-viewport").down("treepanel");var v=C.getRootNode();var z=C.getSelectionModel().getSelection()[0];if(!z){z=v.childNodes[0]}var u=Ext.getCmp("app-viewport").createGadgets(o,i,false);Ext.apply(u,{activeGroup:true,text:o.name,leaf:true});z.appendChild(u)};m.savePortal(p,q)};var e=function(){l.getBody().find("ul.box [name=gadgetItem]").bind("click",function(){f($(this).attr("id"))})};var b=function(m){var n='<ul class="box">';$.each(m,function(q,o){var p='<li id="'+o.id+'" name="gadgetItem" title="'+o.desc+'">';p+="<a>";p+='<img width="48" height="48" align="absMiddle" src="'+(portalImageBaseUrl+o.imageUrl)+'">';p+='<span class="lleft">';p+='<span class="lright">'+o.name+"</span>";p+="</span>";p+="</a>";p+="</li>";n+=p});n+="</ul>";return n};var j=function(){if(d){$.ajax({type:"POST",dataType:"json",data:{portalId:i},url:eastcom.baseURL+"/portal/queryUserAddGadgets",success:function(m){if(m.success=="true"){k=m.data;var n=b(k);l.updateContent($(n));e();Ext.getCmp(i).gadgetsRemoved=false;d=false}}})}};CommonWindow.call(l,g);l.setPortalId=function(m){i=m;l.setNeedReload()};l.getPortalId=function(m){return i};l.setNeedReload=function(){d=true};var a=l.show;l.show=function(n){var m=function(){j();if(typeof(n)=="function"){n()}};a(m)}};