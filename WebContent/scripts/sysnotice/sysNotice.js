Eastcom.modules.sysNotice=(function(){var d={notIconId:"nocbox",panelId:"new_noc_panel",noTitle:{id:"new_noc_title",spanClass:{num:"noc_iterm_num",close:"noc_iterm_close",history:"noc_iterm_history"}},notipId:"nocbox_tips",noListId:"new_noc_list",buttons:{viewAllNoc:"ViewAllNoc",closeBtn:"CloseBtn"},closeTimeout:3,rqRate:60000,userNotjsp:"/pages/notify/userNotifications.jsp"};var e=null,a=null;var f=new Array();var g=[];var b=[];var c={initNotice:function(){$("#"+d.notIconId).css({display:"block"});var j=this;$("#"+d.notIconId+",#south table td div.numinfo span").click(function(){var k=$("#"+d.panelId).css("display");k=="none"?j.shownoticepanel():j.closeNoc()});var h="#"+d.panelId+" > #"+d.noTitle.id+" >span."+d.noTitle.spanClass.close+",#"+d.buttons.closeBtn;$(h).click(function(){j.closeNoc()});var i=$("#"+d.noListId+" > div.noc_iterm > ul.noc_iterm_data > li");i.live("mouseenter",function(){$(this).addClass("noc_iterm_hover")});i.live("mouseleave",function(){$(this).removeClass("noc_iterm_hover")});$("#"+d.noListId+" > div.noc_iterm > ul.noc_iterm_data > li").live("click",function(){var k=$(this).attr("sms_id");f.push(k);j.removeNoc($(this),k);j.closeNoc();Eastcom.closeTab("show_noc_detail_info");Eastcom.createTab("show_noc_detail_info",NOTIFY_DETAIL,"_noc_detail_info","/pages/notify/notificationDetail.jsp?id="+k,NOTIFY_DETAIL)});$("#"+d.noListId+" > div.noc_iterm > .noc_iterm_title > .noc_iterm_cancel").live("click",function(){var l=$(this).attr("type_id");var k=j.getNocIds(l);j.removeNoc($(this),k)});$("#"+d.buttons.viewAllNoc).live("click",function(){var k=j.getNocIds();j.removeNoc($(this),k,true)});j.getUserNoc(0);setTimeout(function(){j.getUserNoc(0)},60000)},reqNewNotice:function(){var h=this;if(a){window.clearTimeout(a)}a=window.setTimeout(function(){h.reqNewNotice()},d.rqRate);h.getUserNoc()},shownoticepanel:function(k){var j=this;var n=d.panelId;var h=(window.document.documentElement.clientWidth||window.document.body.clientWidth||window.innerWidth);var i=(window.document.documentElement.clientHeight||window.document.body.clientHeight||window.innerHeight);var m=Math.floor((h-jQuery("#"+n).outerWidth())/2);var l=Math.floor((i-jQuery("#"+n).outerHeight())/2)-100;jQuery("#"+n).css({left:m,top:l});jQuery("#"+n).show().focus();j.loadNocData(k)},getUserNoc:function(h){var i=this;var h=typeof(h)=="undefined"?1:0;jQuery.ajax({type:"POST",async:false,dataType:"json",data:{isInterval:h},url:Eastcom.baseURL+"/sysmng/notification/initRelationAndGetUserNocInfo",success:function(k){if(k.success=="true"){var l=k.data;if(l){i.logNocId(l);if(h=="0"){if(!jQuery.isEmptyObject(l)){i.shownoticepanel(l)}}else{var j=i.judgeHasNew();if(j){i.shownoticepanel(l)}}}}}})},loadNocData:function(j){var i=this;var h=d.notipId;if(j!=undefined&&j!=null){jQuery("#"+h).empty().hide();i.formatNoc(j)}else{jQuery("#"+h).html('<div class="loading">'+MSG_DATA_LOADING+"</div>").show();jQuery("#"+d.noListId).hide();jQuery.ajax({type:"POST",async:false,dataType:"json",data:{isInterval:1},url:Eastcom.baseURL+"/sysmng/notification/initRelationAndGetUserNocInfo",success:function(k){jQuery("#"+h).empty().hide();if(k.success=="true"){var l=k.data;if(!jQuery.isEmptyObject(l)){i.formatNoc(l)}else{jQuery("#"+d.panelId).css("padding-bottom","0px");i.autocloseNoc()}}},error:function(k,m,l){jQuery("#"+d.notipId).html('<div class="error">'+NOTIFY_LOAD_FAILED+"("+k.status+")："+m+"</div>").show()}})}},formatNoc:function(m){var l=this;var i=totalnum="";jQuery("#"+d.noListId).empty();m.sort(function(o,n){if(o.effectStartTime>n.effectStartTime){return -1}if(o.effectStartTime<n.effectStartTime){return 1}return 0});jQuery.each(m,function(n,p){if(p.id==""||l.hasRead(p.id)){return false}var o=p.title;if(jQuery("#"+d.noListId).find(".noc_iterm_"+p.type).size()!=0){i='<li id="noc_li_'+p.id+'" sms_id="'+p.id+'" type_id="'+p.type+'" title="'+o+'">';i+='<div class="noc_iterm_time">'+NOTIFY_ABOUT+p.sendTime+NOTIFY_AGO+'</div><div class="noc_iterm_content">'+o+"</div>";i+="</li>";jQuery(".noc_iterm_"+p.type+" >s ul").append(i)}else{i='<div class="noc_iterm noc_iterm_'+p.type+'">';i+='<div class="noc_iterm_title"><span class="noc_iterm_cancel" type_id="'+p.type+'" title="'+NOTIFY_ALL_READ+'"></span>'+p.typeName+"</div>";i+='<ul class="noc_iterm_data">';i+='<li id="noc_li_'+p.id+'" sms_id="'+p.id+'" type_id="'+p.type+'" title="'+o+'">';i+='<div class="noc_iterm_time">'+NOTIFY_ABOUT+p.sendTime+NOTIFY_AGO+'</div><div class="noc_iterm_content">'+o+"</div>";i+="</li>";i+="</ul>";i+="</div>";jQuery("#"+d.noListId).append(i)}});if(jQuery.isEmptyObject(m)){l.autocloseNoc()}else{jQuery("#"+d.noListId).show()}var h=l.getNocNum();var k="#"+d.panelId+" > #"+d.noTitle.id+" > ."+d.noTitle.spanClass.num+" > span";jQuery(k).html(h);if(h>=1){jQuery("#"+d.panelId).css("padding-bottom","0px");jQuery("#"+d.panelId+" > .button > a").show()}else{jQuery("#"+d.panelId+" > .button > #"+d.buttons.viewAllNoc).hide()}var j="#"+d.panelId+" > #"+d.noTitle.id+" > ."+d.noTitle.spanClass.history+" > a";jQuery(j).click(function(){l.closeNoc();Eastcom.createTab("show_remind_histroy",NOTIFY_ALL_MSG,"personal_history_noc",d.userNotjsp,NOTIFY_ALL_MSG)})},autocloseNoc:function(){var l=this;var i=l.getNocNum();var k="#"+d.panelId+" > #"+d.noTitle.id+" > ."+d.noTitle.spanClass.num+" > span";jQuery(k).html(i);if(!(i>0)){jQuery("#"+d.noListId).hide();var j=Eastcom.sprintf(NOTIFY_CLOSE_AFTER,"<span class='red'>"+d.closeTimeout+"</span>");jQuery("#"+d.notipId).html("<h2>"+NOTIFY_NO_NEW_MSG+"</h2><br />"+j).show();window.clearInterval(e);e=window.setInterval(l.timerClose,1000);var h="#"+d.panelId+" > .button > #"+d.buttons.viewAllNoc;jQuery(h).hide()}},closeNoc:function(){jQuery("#"+d.panelId).hide();if(e){window.clearInterval(e);e=null}},hasRead:function(h){return jQuery.inArray(h,f)>-1?true:false},getNocNum:function(){var i=0;i=jQuery("#"+d.panelId+" > #"+d.noListId+" > .noc_iterm > .noc_iterm_data > li").length;var h=jQuery("#south table td div.numinfo");$(h).find("span").html(i).css("color","red");if(i>0){$("#"+d.notIconId).css("background-image",'url("'+Eastcom.baseURL+'/static/images/themes/blue/main/nobox_.gif")');$(h).show()}else{$("#"+d.notIconId).css("background-image",'url("'+Eastcom.baseURL+'/static/images/themes/blue/main/nobox.png")');$(h).hide()}return i},timerClose:function(){var i=this;var h="#"+d.notipId+" > span";var j=jQuery(h).text();if(j>1){jQuery(h).text(j-1)}else{c.closeNoc()}},removeNoc:function(l,j,h){var k=this;if(!j){return}var i=new Date().format("yyyy-MM-dd hh:mm:ss");jQuery.ajax({type:"POST",async:true,dataType:"json",url:Eastcom.baseURL+"/sysmng/notificationLog/saveNocLog",data:{viewTime:i,ids:j},success:function(n){if(n&&n.data==true){var m=k.getNocNum();if(h){jQuery("#new_noc_list").empty();jQuery("#new_noc_panel > #new_noc_title > .noc_iterm_num >span").html(m);jQuery("#new_noc_panel > .button").find("#ViewAllNoc,#ViewDetail").hide();k.closeNoc()}else{var o=l.parents(".noc_iterm").find("ul").find("li").size();if(j.indexOf(",")!="-1"){l.parents(".noc_iterm").remove()}else{o==1?l.parents(".noc_iterm").remove():l.remove()}jQuery("#new_noc_panel > #new_noc_title > .noc_iterm_num >span").html(m);if(m==0){jQuery("#new_noc_panel > .button").find("#ViewAllNoc,#ViewDetail").hide()}}}k.autocloseNoc()},error:function(n,p,o){jQuery("#new_noc_list").hide();jQuery("#nocbox_tips").html('<div class="error">'+td_lang.inc.msg_24+"("+n.status+")："+p+"</div>").show();var m=Eastcom.sprintf(NOTIFY_OPT_FAILED,p);alert(m)}})},getNocIds:function(h){var l="",j="",i=null;var k="#"+d.panelId+" > #"+d.noListId;if(h!=""&&typeof(h)!=="undefined"){i=jQuery(k+"> .noc_iterm_"+h+" > .noc_iterm_data > li")}else{i=jQuery(k+" > .noc_iterm > .noc_iterm_data > li")}jQuery.each(i,function(){var m=jQuery(this).attr("sms_id");f.push(m);l+=j+m;j=","});return l},logNocId:function(h){b=[];b=g;g=[];jQuery.each(h,function(i,j){g.push(j.id)})},judgeHasNew:function(){var h=b.length;var i=jQuery.merge(b,g);var j=jQuery.uniqueArray(i);return j.length==h?false:true}};jQuery.extend({uniqueArray:function(j){var m=[];for(var k=0,h=j.length;k<h;++k){if(jQuery.inArray(j[k],m)<0){m.push(j[k])}}return m}});Date.prototype.format=function(i){var j={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};if(/(y+)/.test(i)){i=i.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))}for(var h in j){if(new RegExp("("+h+")").test(i)){i=i.replace(RegExp.$1,RegExp.$1.length==1?j[h]:("00"+j[h]).substr((""+j[h]).length))}}return i};return{initNotice:function(){c.initNotice()}}})();