Ext.Loader.setConfig({enabled:true});Ext.Loader.setPath("Ext.ux",extDir+"/ux");Ext.Loader.setPath("Ext.components",eastcom.baseURL+"/static/commonjs/components");Ext.require(["Ext.grid.*","Ext.data.*","Ext.ux.RowExpander","Ext.components.BaseDataComboBox","Ext.components.DateTimeField"]);eastcom.modules.sysLogMng=(function(){var b=null;var g=null;Ext.define("Log",{extend:"Ext.data.Model",fields:[{name:"id",type:"string"},{name:"moduleCode",type:"string"},{name:"logLevel",type:"string"},{name:"host",type:"string"},{name:"message",type:"string"},{name:"username",type:"string"},{name:"deptId",type:"string"},{name:"deptName",type:"string"},{name:"operateType",type:"string"},{name:"appHost",type:"string"},{name:"qryusedTime",type:"int"},{name:"recordTime",type:"string"}]});var f=Ext.create("Ext.data.Store",{model:"Log",pageSize:eastcom.pageSize,autoLoad:true,proxy:{type:"ajax",url:eastcom.baseURL+"/sysmng/sysLogQuery",reader:{type:"json",root:"elements",totalProperty:"total"},actionMethods:{read:"POST"},timeout:180000},listeners:{load:function(j){var k=Ext.getCmp("exportBtn");k.setDisabled(j&&j.length)}}});var c=Ext.create("Ext.window.Window",{title:BUTTON_EXPORT,modal:true,height:currentUserTheme=="neptune"?160:140,width:300,layout:"fit",resizable:false,closeAction:"hide",listeners:{show:function(){Ext.getCmp("dataScopeRadioGroup").setValue({dataScope:"2"});Ext.getCmp("dataScopeRadioGroup").setValue({dataScope:"1"})}},items:[{xtype:"form",border:false,defaults:{xtype:"radiogroup",vertical:true,labelAlign:"right",columns:2,margin:10,labelWidth:65},items:[{id:"dataScopeRadioGroup",fieldLabel:"数据范围",listeners:{change:function(k,j){var l=Ext.getCmp("fileType-xls");if(j.dataScope=="1"){if(g.total>=65535){Ext.getCmp("fileTypeRadioGroup").setValue({fileType:"csv"});l.setDisabled(true)}else{l.setDisabled(false)}}else{l.setDisabled(false)}}},items:[{boxLabel:"所有数据",name:"dataScope",inputValue:"1",checked:true},{boxLabel:"单页数据",name:"dataScope",inputValue:"2"}]},{id:"fileTypeRadioGroup",fieldLabel:"导出类型",items:[{id:"fileType-xls",boxLabel:'<img style="height:14px;width:14px;margin-right:2px" src="'+eastcom.baseURL+'/static/images/common/icons/xls.gif"></img>xls',name:"fileType",inputValue:"xls",checked:true},{id:"fileType-csv",boxLabel:'<img style="height:14px;width:14px;margin-right:2px" src="'+eastcom.baseURL+'/static/images/common/icons/csv.gif"></img>csv',name:"fileType",inputValue:"csv"}]}]}],buttons:[{text:BUTTON_OK,handler:function(){var k=Ext.getCmp("dataScopeRadioGroup").getChecked()[0].inputValue;var j=Ext.getCmp("fileTypeRadioGroup").getChecked()[0].inputValue;i(k,j)}},{text:BUTTON_CANCEL,handler:function(){c.hide()}}]});function i(n,j){var k=(n=="1");var l=eastcom.baseURL+"/sysmng/exportSysLog?queryTotal="+k+"&fileType="+j;if(b!=null){for(var m in b){l+=("&"+m+"="+b[m])}}if(!k){if(g){l+=("&start="+(g.fromRecord-1)+"&limit="+eastcom.pageSize)}else{l+=("&start=0&limit="+eastcom.pageSize)}}window.open(encodeURI(l))}function e(j){if(j=="0"){return'<span style="color:red;">'+MSG_FAILURE+"</span>"}else{if(j=="1"){return'<span style="color:green;">'+MSG_SUCCESS+"</span>"}}return j}var d=Ext.create("Ext.grid.Panel",{region:"center",useArrows:true,fit:true,store:f,autoHeight:true,columnLines:true,enableColumnHide:eastcom.enableColumnHide,tbar:[{iconCls:"icon-xls",id:"exportBtn",text:BUTTON_EXPORT,disabled:true,handler:function(){c.show()}}],columns:[{text:LOG_MODULE_NAME,flex:1,sortable:false,dataIndex:"moduleCode",minWidth:250},{text:LOG_OPT_USER,sortable:false,width:230,dataIndex:"username",align:"center"},{text:LOG_OPT_USER,sortable:false,width:230,hidden:true,dataIndex:"deptId",align:"center"},{text:NOTIFY_DEPT,sortable:false,width:120,dataIndex:"deptName",align:"center"},{text:LOG_OPT_TIME,width:140,dataIndex:"recordTime",sortable:false,align:"center"},{text:LOG_IP_ADDR,sortable:false,dataIndex:"host",align:"center",width:120},{text:LOG_HOST_ADDR,sortable:false,dataIndex:"appHost",align:"center",width:120},{text:LOG_USE_TIME,dataIndex:"qryusedTime",sortable:true,align:"center",width:100},{text:LOG_STATUS,sortable:false,dataIndex:"logLevel",align:"center",renderer:e,width:90}],plugins:[{ptype:"rowexpander",rowBodyTpl:["<p><b>"+LOG_LOG+":</b>{message}</p>"]}],bbar:Ext.create("Ext.components.BaseCommonPagingToolbar",{store:f,listeners:{change:function(k,j){g=j}}}),animCollapse:false,renderTo:Ext.getBody()});function a(){var j=f.proxy;var k={startTime:Ext.getCmp("validStarttime").getValue(),endTime:Ext.getCmp("validEndtime").getValue(),moduleCode:Ext.getCmp("moduleCode").getValue(),logLevel:(Ext.getCmp("logLevel").getValue()=="_ALL_")?"":Ext.getCmp("logLevel").getValue(),host:Ext.getCmp("host").getValue(),userlevel:"",username:Ext.getCmp("username").getValue(),message:Ext.getCmp("message").getValue()};if(k.logLevel==null){k.logLevel=""}j.extraParams=k;f.loadPage(1,{start:0,limit:eastcom.pageSize,callback:function(){b=k}})}function h(){Ext.create("Ext.Viewport",{layout:{type:"border",padding:5},items:[{region:"north",padding:"0 0 5 0",xtype:"form",bodyPadding:10,items:[{xtype:"fieldcontainer",fieldLabel:LOG_OPT_TIME,labelWidth:80,labelAlign:"right",layout:"hbox",items:[{xtype:"datetimefield",allowBlank:true,width:200,endTimeField:{id:"validEndtime"},name:"validStarttime",id:"validStarttime",timeConfig:{maxDate:new Date().format("yyyy-MM-dd 00:00:00"),dateFmt:"yyyy-MM-dd 00:00:00",}},{xtype:"label",text:"-",margins:"0 10 0 10"},{xtype:"datetimefield",allowBlank:true,width:200,name:"validEndtime",id:"validEndtime",startTimeField:{id:"validStarttime"},timeConfig:{dateFmt:"yyyy-MM-dd 23:59:59",maxDate:new Date().format("yyyy-MM-dd 23:59:59"),}},{xtype:"splitter"},{xtype:"button",style:"margin-left:20px",formBind:true,iconCls:"icon-search",width:70,text:BUTTON_SEARCH,handler:a}]},{xtype:"fieldset",checkboxToggle:true,collapsed:true,title:MSG_MORE_CONDITION,layout:"column",autoScroll:true,defaults:{layout:"anchor",defaults:{anchor:"100%",labelAlign:"right"}},items:[{columnWidth:1/3,defaultType:"textfield",baseCls:"x-plain",items:[{id:"logLevel",xtype:"baseDataComboBox",parentName:"operateStatus",fieldLabel:LOG_STATUS},{id:"userlevel",xtype:"baseDataComboBox",parentName:"userLevel",allFlag:false,disabled:true,fieldLabel:LOG_USER_LEVEL}]},{columnWidth:1/3,defaultType:"textfield",baseCls:"x-plain",items:[Ext.create("Ext.components.ModuleChooserField",{id:"moduleCode",fieldLabel:LOG_MODULE_NAME,editable:false,labelAlign:"right",emptyText:MSG_CHOOSE_ONE}),Ext.create("Ext.components.UserChooserField",{id:"username",fieldLabel:LOG_OPT_USER,editable:false,labelAlign:"right",emptyText:MSG_CHOOSE_ONE})]},{columnWidth:1/3,defaultType:"textfield",baseCls:"x-plain",items:[{id:"host",xtype:"textfield",fieldLabel:LOG_IP_ADDR},{id:"message",xtype:"textfield",fieldLabel:LOG_LOG}]}]}]},d]})}return{initComponent:h}})();