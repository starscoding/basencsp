Ext.Loader.setConfig({enabled:true});Ext.Loader.setPath("Ext.ux",extDir+"/ux");Ext.Loader.setPath("Ext.components",eastcom.baseURL+"/static/commonjs/components");Ext.require(["Ext.grid.*","Ext.form.*","Ext.grid.property.*","Ext.data.*","Ext.ux.RowExpander","Ext.components.BaseDataComboBox","Ext.components.DateTimeField","Ext.components.ExportWin"]);eastcom.modules.regionOnlieLog=(function(){var f="";var Q="";var k="";var x=new Ext.util.HashMap();var O=new Ext.util.HashMap();require.config({paths:{echarts:"http://echarts.baidu.com/build/dist"}});function L(V){var S=[];var U=[];x=new Ext.util.HashMap();for(var R in V){x.add(V[R]["xvalue"],V[R]["departmentId"]);S.push(V[R]["yvalue"]);U.push(V[R]["xvalue"])}var T={tooltip:{show:true},legend:{data:["登录次数(次)"]},grid:{y2:80},xAxis:[{type:"category",data:U,boundaryGap:true,axisLabel:{rotate:-20}}],yAxis:[{type:"value"}],series:[{name:"登录次数(次)",type:"bar",data:S,itemStyle:{normal:{lineStyle:{type:"solid"},color:"#62bdff"}}}]};return T}function J(S,R){require(["echarts","echarts/chart/bar"],function(V){var T=require("echarts/config");var U=V.init(document.getElementById(S));U.setOption(R);U.on(T.EVENT.CLICK,P)})}function y(S,R){require(["echarts","echarts/chart/bar"],function(V){var T=require("echarts/config");var U=V.init(document.getElementById(S));U.setOption(R);U.on(T.EVENT.CLICK,G)})}function t(S,R){require(["echarts","echarts/chart/bar"],function(U){var T=U.init(document.getElementById(S));T.setOption(R)})}function P(V){var U=document.getElementById("chartLeft");var R=V.name;var S=x.get(R);Q=S;k="";var T={timeType:Ext.getCmp("timeType").getValue(),sTime:Ext.getCmp("startTime").getValue(),eTime:Ext.getCmp("endTime").getValue(),departmentId:S};b(T,"chartLeft");D(T,"chartRight")}function G(W){var V=document.getElementById("chartRight");var S=W.name;var R=O;var T=O.get(S);k=T;var U={timeType:Ext.getCmp("timeType").getValue(),sTime:Ext.getCmp("startTime").getValue(),eTime:Ext.getCmp("endTime").getValue(),departmentId:Q,moduleCode:T};D(U,"chartRight")}var q={qryChartUrl:eastcom.baseURL+"/sysmng/qryTopRegionOnlineLogs.do"};var e={timeType:"A",users:[],sTime:"",eTime:"",xTime:""};var A=function(){param=Ext.apply(e,{expanded:true,timeType:Ext.getCmp("timeType").getValue(),sTime:Ext.getCmp("startTime").getValue(),eTime:Ext.getCmp("endTime").getValue(),departmentIds:f});return param};var w=Ext.create("Ext.form.ComboBox",{fieldLabel:"时间范围",id:"timeType",width:200,labelWidth:70,labelAlign:"right",value:"A",store:{xtype:"store",fields:["value","name"],data:[{value:"A",name:"全部"},{value:"M",name:"当月"},{value:"D",name:"当日"},{value:"X",name:"自定义"}]},queryMode:"local",displayField:"name",valueField:"value",listeners:{change:function(S,U,R,T){if(U==="X"){Ext.getCmp("startTime").show();Ext.getCmp("endTime").show()}else{Ext.getCmp("startTime").hide().reset();Ext.getCmp("endTime").hide().reset()}}}});Ext.define("Log",{extend:"Ext.data.Model",fields:[{name:"id",type:"string"},{name:"liveTime",type:"string"},{name:"loginCount",type:"string"},{name:"parentId",type:"string"},{name:"nameCn",type:"string"}]});var n=[{xtype:"treecolumn",dataIndex:"nameCn",sortable:false,text:"地市部门名称",width:185}];var I=[{id:"deptName",dataIndex:"deptName",flex:1,align:"left",sortable:true,header:"地市部门名称",width:185},{id:"fullName",dataIndex:"fullName",flex:1,align:"left",sortable:true,header:"用户名",width:185},{id:"liveTime",dataIndex:"liveTime",flex:1,align:"left",sortable:true,header:"在线时长",width:185},{id:"loginCount",dataIndex:"loginCount",sortable:true,header:"登录次数",flex:1,align:"left",width:60}];var s=null;Ext.define("regionLogTarget",{extend:"Ext.data.Model",fields:[{name:"id",type:"string"},{name:"parentId",type:"string"},{name:"nameCn",type:"string"},{name:"leaf",type:"boolean"}]});var c=Ext.create("Ext.data.TreeStore",{model:"regionLogTarget",proxy:{type:"ajax",actionMethods:"POST",url:eastcom.baseURL+"/sysmng/getAllRegionLogData",extraParams:{timeType:"A",expanded:true}},listeners:{load:function(){}},timeout:180000});Ext.define("deptLogTarget",{extend:"Ext.data.Model",fields:[{name:"deptName",type:"string"},{name:"fullName",type:"string"},{name:"liveTime",type:"string"},{name:"loginCount",type:"string"}]});var z=Ext.create("Ext.data.Store",{model:"deptLogTarget",pageSize:eastcom.pageSize,autoLoad:true,proxy:{type:"ajax",actionMethods:"POST",url:eastcom.baseURL+"/sysmng/qryDeptLogData",reader:{type:"json",idProperty:"oid",root:"data.elements",totalProperty:"data.total"},extraParams:{timeType:"A",sTime:null,eTime:null,departmentIds:null}},timeout:180000,listeners:{load:function(){}}});Ext.define("userLogTarget",{extend:"Ext.data.Model",fields:[{name:"moduleCode",type:"string"},{name:"userName",type:"string"},{name:"fullname",type:"string"},{name:"deptId",type:"string"},{name:"deptName",type:"string"},{name:"optTimes",type:"string"}]});var C=Ext.create("Ext.data.Store",{model:"userLogTarget",pageSize:eastcom.pageSize,autoLoad:true,proxy:{type:"ajax",actionMethods:"POST",url:eastcom.baseURL+"/sysmng/qryUserLogData",reader:{type:"json",idProperty:"oid",root:"data.elements",totalProperty:"data.total"},extraParams:{timeType:"A",sTime:null,eTime:null,departmentId:null,moduleCode:null}},timeout:180000,listeners:{load:function(){}}});var F=Ext.create("Ext.PagingToolbar",{pageSize:eastcom.pageSize,store:z,displayInfo:true,listeners:{change:function(S,R){s=R}}});var j=Ext.create("Ext.PagingToolbar",{pageSize:eastcom.pageSize,store:C,displayInfo:true,listeners:{change:function(S,R){s=R}}});function u(T,R,S){var S=S||A();Ext.Ajax.request({url:R||q.qryChartUrl,method:"POST",async:false,params:S,disableCaching:true,success:function(U){var W=Ext.decode(U.responseText);var V=L(W.data.elements);var X="chartDept";J(X,V)},failure:function(U,V){Ext.MessageBox.alert("提示消息","请求失败，请重试");Ext.Msg.show({title:"提示消息",msg:"请求失败，请重试",buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}})}function b(R,S){Ext.Ajax.request({url:eastcom.baseURL+"/sysmng/qryModuleLogsByDeptId",method:"POST",async:false,params:R,disableCaching:true,success:function(U){var Z=Ext.decode(U.responseText);var T=Z.data.elements;var X=[];var Y=[];O=new Ext.util.HashMap();for(var W in T){O.add(T[W]["xvalue"],T[W]["moduleCode"]);X.push(T[W]["yvalue"]);Y.push(T[W]["xvalue"])}var V={tooltip:{show:true},legend:{data:["模块操作次数TOP10(次)"]},grid:{y2:110},xAxis:[{type:"category",data:Y,boundaryGap:true,axisLabel:{rotate:-20}}],yAxis:[{type:"value"}],series:[{name:"模块操作次数TOP10(次)",type:"bar",data:X,itemStyle:{normal:{lineStyle:{type:"solid"},color:"#62bdff"}}}]};var aa=S;y(aa,V)},failure:function(T,U){Ext.MessageBox.alert("提示消息","请求失败，请重试");Ext.Msg.show({title:"提示消息",msg:"请求失败，请重试",buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}})}function D(R,S){Ext.Ajax.request({url:eastcom.baseURL+"/sysmng/qryUserLogsByDeptId",method:"POST",async:false,params:R,disableCaching:true,success:function(U){var Z=Ext.decode(U.responseText);var T=Z.data.elements;var X=[];var Y=[];for(var W in T){X.push(T[W]["yvalue"]);Y.push(T[W]["xvalue"])}var V={tooltip:{show:true},legend:{data:["用户操作次数TOP10(次)"]},xAxis:[{type:"category",data:Y,boundaryGap:true,axisLabel:{rotate:-20}}],yAxis:[{type:"value"}],series:[{name:"用户操作次数TOP10(次)",type:"bar",data:X,itemStyle:{normal:{lineStyle:{type:"solid"},color:"#62bdff"}}}]};var aa=S;y(aa,V)},failure:function(T,U){Ext.MessageBox.alert("提示消息","请求失败，请重试");Ext.Msg.show({title:"提示消息",msg:"请求失败，请重试",buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}})}var H=Ext.create("Ext.tree.TreePanel",{region:"west",id:"regionLogTreePanel",title:"部门",width:187,title:"",useArrows:true,collapsible:true,fit:true,animate:false,stateful:true,rootVisible:false,autoHeight:true,enableColumnHide:eastcom.enableColumnHide,store:c,columns:n,listeners:{selectionchange:function(V,T){var U=this;if(T.length>0){if(T){var W=[];var R=T[0];W=a(R,W);f="";if(W!=null&&W.length>0){for(var S=0;S<W.length;S++){f+=("'"+W[S]+"',")}f=f.substr(0,f.length-1)}else{f="'"+R.data.id+"'"}u("chartDept","",null);var X={timeType:Ext.getCmp("timeType").getValue(),sTime:Ext.getCmp("startTime").getValue(),eTime:Ext.getCmp("endTime").getValue(),departmentId:R.data.id};Q=R.data.id;k="";b(X,"chartLeft");D(X,"chartRight")}}}}});var E=new Ext.Panel({region:"north",id:"deptChartAndGridPanel",layout:"card",activeItem:0,height:250,items:[{tbar:["地市登录统计",{xtype:"tbfill"},{icon:"../../static/images/default/chart_bar.png",tooltip:"查看图表",handler:function(){Ext.getCmp("deptChartAndGridPanel").getLayout().setActiveItem(0)}},"-",{icon:"../../static/images/default/data_list_num.png",tooltip:"查看表格数据",handler:function(){Ext.getCmp("deptChartAndGridPanel").getLayout().setActiveItem(1);d(A())}}],id:"chartDeptPanel",border:false,xtype:"panel",html:"<div id ='chartDept' style='height:100%' ></div>"},m()]});var i=new Ext.Panel({region:"west",id:"moduleChartAndGridPanel",layout:"card",activeItem:0,bodyStyle:"border-width:0 1px 0 0;",height:250,autoScroll:true,width:"50%",items:[{tbar:["模块操作统计",{xtype:"tbfill"},{icon:"../../static/images/default/chart_bar.png",tooltip:"查看图表",handler:function(){}}],id:"chartLeftPanel",border:false,autoScroll:true,xtype:"panel",html:"<div id ='chartLeft' style='height:300;' ></div>"},M()]});var o=new Ext.Panel({region:"center",id:"userChartAndGridPanel",layout:"card",bodyStyle:"border-width:0 1px 0 0;",activeItem:0,height:250,autoScroll:true,width:"50%",items:[{autoScroll:true,tbar:["用户操作统计",{xtype:"tbfill"},{icon:"../../static/images/default/chart_bar.png",tooltip:"查看图表",handler:function(){Ext.getCmp("userChartAndGridPanel").getLayout().setActiveItem(0)}},"-",{icon:"../../static/images/default/data_list_num.png",tooltip:"查看表格数据",handler:function(){Ext.getCmp("userChartAndGridPanel").getLayout().setActiveItem(1);var R={timeType:Ext.getCmp("timeType").getValue(),sTime:Ext.getCmp("startTime").getValue(),eTime:Ext.getCmp("endTime").getValue(),departmentId:Q,moduleCode:k};C.proxy.extraParams=R;C.load()}}],id:"chartRightPanel",border:false,xtype:"panel",html:"<div id ='chartRight' style='height:100%' ></div>"},g()]});function a(T,U){var S=T.childNodes;for(var R=0;R<S.length;R++){U.push(S[R].data.id)}return U}var p=function(S){var R=S||A();c.proxy.extraParams=R;c.load()};var d=function(S){var R={timeType:Ext.getCmp("timeType").getValue(),sTime:Ext.getCmp("startTime").getValue(),eTime:Ext.getCmp("endTime").getValue(),departmentIds:Q};z.proxy.extraParams=R;z.load()};var v=function(R){alert("1");C.proxy.extraParams=R;C.load()};var s=null;var B=null;var l=function(X,R){var T=(X=="all");var Y=Ext.getCmp("timeType").getValue();var S=Ext.getCmp("startTime").getValue();var W=Ext.getCmp("endTime").getValue();var U=eastcom.baseURL+"/sysmng/exportDeptLog?queryTotal="+T+"&fileType="+R+"&timeType="+Y+"&sTime="+S+"&eTime="+W+"&departmentIds="+Q;if(B!=null){for(var V in B){U+=("&"+V+"="+B[V])}}if(!T){if(s){U+=("&start="+(s.fromRecord-1)+"&limit="+eastcom.pageSize)}else{U+=("&start=0&limit="+eastcom.pageSize)}}U+="&type=module";window.open(encodeURI(U))};var K=Ext.create("Ext.components.ExportWin",{doExport:function(S,R){l(S,R)},getTotal:function(){if(s){return s.total}else{return 0}}});var N=function(X,R){var T=(X=="all");var Y=Ext.getCmp("timeType").getValue();var S=Ext.getCmp("startTime").getValue();var W=Ext.getCmp("endTime").getValue();var U=eastcom.baseURL+"/sysmng/exportUserLog?queryTotal="+T+"&fileType="+R+"&timeType="+Y+"&sTime="+S+"&eTime="+W+"&departemntId="+Q+"&moduleCode="+k;if(B!=null){for(var V in B){U+=("&"+V+"="+B[V])}}if(!T){if(s){U+=("&start="+(s.fromRecord-1)+"&limit="+eastcom.pageSize)}else{U+=("&start=0&limit="+eastcom.pageSize)}}U+="&type=module";window.open(encodeURI(U))};var r=Ext.create("Ext.components.ExportWin",{doExport:function(S,R){N(S,R)},getTotal:function(){if(s){return s.total}else{return 0}}});function h(){Ext.create("Ext.Viewport",{layout:{type:"border"},padding:"5 5 5 5",autoScroll:true,height:1800,defaults:{},items:[H,{region:"center",id:"userMainPanel",layout:"border",bodyStyle:"border-width:0px 0px 1px 0;",items:[{region:"north",autoScroll:true,xtype:"panel",layout:"column",bodyPadding:10,margin:"0 0 5 0",bodyStyle:"border-width:1px 1px 1px 0;",defaults:{},items:[w,{allowBlank:true,xtype:"datetimefield",fieldLabel:"开始时间",labelAlign:"right",value:"",width:220,labelWidth:70,name:"startTime",hidden:true,id:"startTime",timeConfig:{maxDate:"%y-%M-%d",dateFmt:"yyyy-MM-dd"}},{allowBlank:true,xtype:"datetimefield",fieldLabel:"结束时间",hidden:true,labelAlign:"right",labelWidth:70,value:"",width:220,name:"endTime",id:"endTime",timeConfig:{maxDate:"%y-%M-%d",dateFmt:"yyyy-MM-dd"}},{xtype:"button",style:"margin-left:20px",id:"search",text:"查询",iconCls:"icon-search",handler:function(S,T){A();u("chartDept","",null);var U={timeType:Ext.getCmp("timeType").getValue(),sTime:Ext.getCmp("startTime").getValue(),eTime:Ext.getCmp("endTime").getValue(),departmentId:""};b(U,"chartLeft");D(U,"chartRight");p(A())}}]},{id:"chartpanel",region:"center",xtype:"panel",border:0,defaults:{border:1},layout:{type:"border"},items:[E,{region:"center",margin:"0 0 5 0",layout:{type:"border",align:"stretch"},height:250,defaults:{border:0},items:[i,o]}]}]}]});u("chartDept","",null);var R={timeType:Ext.getCmp("timeType").getValue(),sTime:Ext.getCmp("startTime").getValue(),eTime:Ext.getCmp("endTime").getValue(),departmentId:""};b(R,"chartLeft");D(R,"chartRight")}function m(){var R=Ext.create("Ext.grid.Panel",{id:"deptLogInfoGrid",store:z,tbar:["地市登录详情列表",{xtype:"tbfill"},"-",{iconCls:"icon-xls",text:BUTTON_EXPORT,handler:function(){K.show()}},"-",{icon:"../../static/images/default/chart_bar.png",tooltip:"查看图表",handler:function(){Ext.getCmp("deptChartAndGridPanel").getLayout().setActiveItem(0);u("chartDept","",null);D}},"-",{icon:"../../static/images/default/data_list_num.png",tooltip:"查看表格数据",handler:function(){Ext.getCmp("deptChartAndGridPanel").getLayout().setActiveItem(1)}}],colModel:I,bbar:F,autoScroll:true,autoShow:true,stripeRows:true,border:false,forceFit:true});return R}function g(){var R=Ext.create("Ext.grid.Panel",{id:"userLogInfoGrid",store:C,tbar:["用户操作详情列表",{xtype:"tbfill"},"-",{iconCls:"icon-xls",text:BUTTON_EXPORT,handler:function(){r.show()}},"-",{icon:"../../static/images/default/chart_bar.png",tooltip:"查看图表",handler:function(){Ext.getCmp("userChartAndGridPanel").getLayout().setActiveItem(0);var S={timeType:Ext.getCmp("timeType").getValue(),sTime:Ext.getCmp("startTime").getValue(),eTime:Ext.getCmp("endTime").getValue(),departmentId:Q,moduleCode:k};D(S,"chartRight")}},"-",{icon:"../../static/images/default/data_list_num.png",tooltip:"查看表格数据",handler:function(){Ext.getCmp("userChartAndGridPanel").getLayout().setActiveItem(1)}}],colModel:[{id:"userfullname",dataIndex:"fullname",flex:1,align:"left",sortable:true,header:"用户名",width:100},{id:"userdeptname",dataIndex:"deptName",flex:1,align:"left",sortable:true,header:"所属部门",width:100},{id:"usermoduleCode",dataIndex:"moduleCode",flex:1,align:"left",sortable:true,header:"操作模块",width:140},{id:"useroptTimes",dataIndex:"optTimes",sortable:true,header:"操作次数",flex:1,align:"left",width:60}],bbar:j,autoScroll:true,autoShow:true,stripeRows:true,border:false,forceFit:true});return R}function M(){}return{initComponent:h}})();Ext.onReady(function(){eastcom.modules.regionOnlieLog.initComponent()});