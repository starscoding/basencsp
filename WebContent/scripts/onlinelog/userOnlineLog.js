Ext.Loader.setConfig({enabled:true});Ext.Loader.setPath("Ext.ux",extDir+"/ux");Ext.Loader.setPath("Ext.components",eastcom.baseURL+"/static/commonjs/components");Ext.require(["Ext.grid.*","Ext.form.*","Ext.grid.property.*","Ext.data.*","Ext.ux.RowExpander","Ext.components.BaseDataComboBox","Ext.components.DateTimeField","Ext.components.ExportWin"]);eastcom.modules.userOnlieLog=(function(){var y=new Ext.util.HashMap();var z=new Ext.util.HashMap();require.config({paths:{echarts:"http://echarts.baidu.com/build/dist"}});function l(F,E){var B=[];var D=[];if(E=="1"){y=new Ext.util.HashMap()}else{if(E=="2"){z=new Ext.util.HashMap()}}for(var A in F){if(E=="1"){y.add(F[A]["xvalue"],F[A])}else{if(E=="2"){z.add(F[A]["xvalue"],F[A])}}B.push(F[A]["yvalue"]);D.push(F[A]["xvalue"])}var C={tooltip:{show:true},legend:{data:["在线时长(秒)"]},xAxis:[{type:"category",data:D}],yAxis:[{type:"value"}],series:[{name:"在线时长(秒)",type:"bar",data:B,itemStyle:{normal:{lineStyle:{type:"solid"},color:"#62bdff"}}}]};return C}function d(C,A,B){require(["echarts","echarts/chart/bar"],function(F){var D=require("echarts/config");var E=F.init(document.getElementById(C));E.setOption(A);if(B=="1"){E.on(D.EVENT.CLICK,m)}else{if(B=="2"){E.on(D.EVENT.CLICK,e)}}})}function e(D){console.log(D);console.log(z);var B=D.name;var A=z.get(B);var E=[];E.push(A.username);t();var C=x.timeType;x=Ext.apply(x,{users:E,xTime:B,timeType:C});s(x)}function m(D){var C=document.getElementById("chartLeft");j("chartLeft","",null,"1");var E=[];console.log(y);console.log(y.get(D.name));E.push(y.get(D.name)["username"]);var A="";t();var B=x.timeType;D=Ext.apply(D,{users:E,xTime:A,timeType:B});Ext.getCmp("chartRightPanel").show();j("chartRight","",D,"2")}var u={qryOnlineUrl:eastcom.baseURL+"/sysmng/qryOnlineLogs.do",qryChartUrl:eastcom.baseURL+"/sysmng/qryTopOnlineLogs.do",qryChartSubUrl:eastcom.baseURL+"/sysmng/qryTopOnlineLogsSub.do",qryReqLogUrl:eastcom.baseURL+"/sysmng/qrySysUserReqLogs.do",exportReqLogUrl:eastcom.baseURL+"/sysmng/exportSysUserReqLogs.do"};var i=Ext.create("Ext.components.UserChooserField",{id:"users",name:"user",hiddenName:"user",submitValueField:"username",fieldLabel:USERNAME,editable:false,labelAlign:"right",emptyText:MSG_CHOOSE_ONE,labelWidth:70,width:300});var x={timeType:"A",users:[],sTime:"",eTime:"",xTime:""};var t=function(){var A=Ext.getCmp("users").getValue();var D=i.getDetailValue();var C=[];if(A&&A!=""){C=A.split(",");for(var B in C){C[B]=D.users[B].userName}}param=Ext.apply(x,{timeType:Ext.getCmp("timeType").getValue(),users:C,sTime:Ext.getCmp("startTime").getValue(),eTime:Ext.getCmp("endTime").getValue(),xTime:""});return param};var w=Ext.create("Ext.form.ComboBox",{fieldLabel:"时间范围",id:"timeType",width:200,labelWidth:70,labelAlign:"right",value:"A",store:{xtype:"store",fields:["value","name"],data:[{value:"A",name:"全部"},{value:"M",name:"当月"},{value:"D",name:"当日"},{value:"X",name:"自定义"}]},queryMode:"local",displayField:"name",valueField:"value",listeners:{change:function(B,D,A,C){if(D==="X"){Ext.getCmp("startTime").show();Ext.getCmp("endTime").show()}else{Ext.getCmp("startTime").hide().reset();Ext.getCmp("endTime").hide().reset()}}}});Ext.define("Log",{extend:"Ext.data.Model",fields:[{name:"id",type:"string"},{name:"timeId",type:"string"},{name:"liveTime",type:"string"},{name:"loginCount",type:"string"},{name:"fullName",type:"string"},{name:"userName",type:"string"}]});var b=[{header:"时间",dataIndex:"timeId",align:"center",hidden:true},{header:"用户名",dataIndex:"fullName",align:"center"},{header:"在线时长（秒）",dataIndex:"liveTime",align:"center"},{header:"登录次数",dataIndex:"loginCount",align:"center"}];var v=null;var f=Ext.create("Ext.data.Store",{model:"Log",pageSize:eastcom.pageSize,autoLoad:true,proxy:{type:"ajax",url:u.qryOnlineUrl,extraParams:x,reader:{type:"json",root:"data.elements",totalProperty:"data.total"},actionMethods:{read:"POST"},timeout:180000},listeners:{load:function(B,A,D,C){v={total:A.length}}}});var g=Ext.create("Ext.data.Store",{fields:[{name:"id",type:"string"},{name:"reqTime",type:"string"},{name:"reqTimeStr",type:"string"},{name:"reqUrl",type:"string"},{name:"serverIp",type:"string"},{name:"clientIp",type:"string"},{name:"sessionId",type:"string"},{name:"userName",type:"string"}],pageSize:eastcom.pageSize,autoLoad:false,proxy:{type:"ajax",url:u.qryReqLogUrl,reader:{type:"json",root:"data.elements",totalProperty:"data.total"},actionMethods:{read:"POST"},timeout:180000}});var h=false;var c=function(G,A){var C=(G=="all");var E=u.exportReqLogUrl+"?queryTotal="+C+"&fileType="+A;var B=null;if(h){B=g}else{B=Ext.getCmp("pageBar").getStore()}var H=B.proxy.extraParams;if(H!=null){for(var F in H){if(H[F] instanceof Array){for(var D in H[F]){E+=("&"+F+"="+H[F][D])}}else{E+=("&"+F+"="+H[F])}}}if(!C){if(v&&v.fromRecord){E+=("&start="+(v.fromRecord-1)+"&limit="+eastcom.pageSize)}else{E+=("&start=0&limit="+eastcom.pageSize)}}else{E+=("&start=0&limit=0")}window.open(encodeURI(E))};var a=Ext.create("Ext.components.ExportWin",{doExport:function(B,A){c(B,A)},getTotal:function(){if(v){return v.total}else{return 0}}});var r=Ext.create("Ext.window.Window",{title:"请求详单",id:"openDetailWin",height:400,width:900,autoDestory:false,resizable:true,closeAction:"hide",buttons:[{xtype:"button",text:"关闭",handler:function(){r.hide()}}],buttonAlign:"right",layout:{type:"vbox",pack:"start",align:"stretch"},items:{flex:1,border:0,id:"detailGrid",xtype:"gridpanel",forceFit:true,tbar:[{iconCls:"icon-xls",text:BUTTON_EXPORT,handler:function(){h=true;a.show()}}],bbar:Ext.create("Ext.PagingToolbar",{store:g,displayInfo:true,listeners:{change:function(B,A){v=A}}}),columns:[{header:"用户名",dataIndex:"userName",align:"center",width:160,hidden:true},{header:"请求地址",dataIndex:"reqUrl",align:"left",flex:1},{header:"服务端IP",dataIndex:"serverIp",align:"center",width:130},{header:"客服端IP",dataIndex:"clientIp",align:"center",width:130},{header:"记录时间",dataIndex:"reqTimeStr",align:"center",width:165}],store:g}});var q=function(B){if(r.isHidden()){r.show()}var A=Ext.getCmp("detailGrid").getStore();A.proxy.extraParams={sessionId:B};A.loadPage(1,{})};var o=function(E,B,A,G,D,C){var F=A.getData()["sessionId"];return E+"&nbsp;&nbsp;&nbsp;&nbsp;<a href=\"javascript:eastcom.modules.userOnlieLog.openDetailWin('"+F+"');\" >查看详情</a>"};var n=[{dataIndex:"id",header:"ID",hidden:true},{dataIndex:"userName",header:"用户名",hidden:true},{dataIndex:"fullName",header:"用户名",align:"center",renderer:o},{dataIndex:"sessionId",header:"会话ID",align:"center",hidden:true},{dataIndex:"startTimeStr",header:"开始时间",align:"center"},{dataIndex:"endTimeStr",header:"结束时间",align:"center"},{dataIndex:"clientIp",header:"用户IP",align:"center"}];var k=Ext.create("Ext.data.Store",{fields:[{name:"id",type:"string"},{name:"sessionId",type:"string"},{name:"userName",type:"string"},{name:"fullName",type:"string"},{name:"startTimeStr",type:"string"},{name:"endTimeStr",type:"string"},{name:"clientIp",type:"string"}],pageSize:eastcom.pageSize,autoLoad:true,proxy:{type:"ajax",url:u.qryOnlineUrl,extraParams:x,reader:{type:"json",root:"data.elements",totalProperty:"data.total"},actionMethods:{read:"POST"},timeout:180000},listeners:{}});function j(D,A,C,B){var C=C||t();Ext.Ajax.request({url:A||u.qryChartUrl,method:"POST",params:C,disableCaching:true,success:function(E){var G=Ext.decode(E.responseText);var F=l(G.data.elements,B);var H=D||"chartLeft";d(H,F,B)},failure:function(E,F){Ext.MessageBox.alert("提示消息","请求失败，请重试");Ext.Msg.show({title:"提示消息",msg:"请求失败，请重试",buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}})}var s=function(B){var A=B||t();f.proxy.extraParams=A;k.proxy.extraParams=A;if((A.users.length==1)&&(A.timeType==="D"||A.xTime.length>=8)){Ext.getCmp("loggrid").reconfigure(k,n);Ext.getCmp("pageBar").bindStore(k);Ext.getCmp("pageBar").getStore().loadPage(1,{})}else{if((!A.users||(A.users&&A.users.length==0))&&A.timeType==="A"){b[0].hidden=true}else{b[0].hidden=false}Ext.getCmp("loggrid").reconfigure(f,b);Ext.getCmp("pageBar").bindStore(f);Ext.getCmp("pageBar").getStore().loadPage(1,{})}Ext.getCmp("loggrid").doLayout()};function p(){Ext.create("Ext.Viewport",{layout:{type:"border"},padding:"5 5 5 5",defaults:{},items:[{region:"north",xtype:"panel",layout:"column",bodyPadding:10,margin:"0 0 5 0",defaults:{},items:[w,i,{allowBlank:true,xtype:"datetimefield",fieldLabel:"开始时间",labelAlign:"right",value:"",width:220,labelWidth:70,name:"startTime",hidden:true,id:"startTime",timeConfig:{maxDate:"%y-%M-%d",dateFmt:"yyyy-MM-dd"}},{allowBlank:true,xtype:"datetimefield",fieldLabel:"结束时间",hidden:true,labelAlign:"right",labelWidth:70,value:"",width:220,name:"endTime",id:"endTime",timeConfig:{maxDate:"%y-%M-%d",dateFmt:"yyyy-MM-dd"}},{xtype:"button",style:"margin-left:20px",id:"search",text:"查询",iconCls:"icon-search",handler:function(A,B){t();j("chartLeft","",null,"1");Ext.getCmp("chartRightPanel").hide();s(t())}}]},{region:"center",xtype:"panel",border:0,defaults:{border:1},layout:{type:"border"},items:[{region:"north",tbar:[{text:"图表",height:22}],margin:"0 0 5 0",layout:{type:"hbox",align:"stretch"},border:1,height:250,defaults:{border:0},items:[{id:"chartLeftPanel",flex:1,html:"<div id ='chartLeft' style='height:100%' ></div>"},{id:"sep",border:1,hidden:true,padding:0,width:2},{id:"chartRightPanel",flex:1,hidden:true,html:"<div id ='chartRight' style='height:100%'></div>",listeners:{hide:function(){Ext.getCmp("sep").hide()},show:function(){Ext.getCmp("sep").show()}}}]},{xtype:"gridpanel",flex:1,region:"center",id:"loggrid",forceFit:true,store:f,columns:b,tbar:["详细信息","->",{iconCls:"icon-xls",text:BUTTON_EXPORT,handler:function(){a.show()}}],bbar:Ext.create("Ext.PagingToolbar",{id:"pageBar",store:f,displayInfo:true,listeners:{change:function(B,A){v=A}}})}]}]});j("chartLeft","",null,"1")}return{initComponent:p,openDetailWin:q}})();Ext.onReady(function(){eastcom.modules.userOnlieLog.initComponent()});