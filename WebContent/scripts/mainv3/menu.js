define(["./utils","./config","./menuitem","./tab","./registerEastcom","text!./template/menu.html"],function(r,s,v,d,w,t){var b={},c=[],g=null,e=0,j={getMainCnt:function(){return $("#main-cnt")},getMenuCnt:function(){return $("#menu")},getMenuNav:function(){return $("#nav")},getMenuPanel:function(){return $("#menu-panel")},getLeftBtn:function(){return $("#menu-left-narrow")},getRightBtn:function(){return $("#menu-right-narrow")}},k={margin_right:65},x={nav:$(t).find("#top-menu-tpl").html(),level2:$(t).find("#menu-level2-tpl").html(),level2_title:$(t).find("#menu-level2-title-inner-tpl").html(),level3:$(t).find("#menu-level3-tpl").html()};var a=function(y){$.ajax({type:"POST",url:eastcom.baseURL+"/loginExtension/getCurrentUserTreeResources",dataType:"json",success:function(z){if(r.validateAjaxRs(z,"用户菜单加载失败")){$.each(z.data,function(B,C){var A=v.create(C);c.push(A)});y(c);w.initPermissionData(c);if(s.menu&&s.menu.length){d.add({menu:v.findMenu("menu-"+s.menu)})}}}})};var p=function(B,A){var D=j.getMenuNav().empty(),F=A*s.menuNum,y=(A+1)*s.menuNum;if(B&&B.length){if(y>B.length){y=B.length}for(var z=F;z<y;z++){var C=B[z];if(C.isMenu()&&!C.isStoped()){var E=r.getTplDom(x.nav,{id:C.getId(),nameCn:C.nameCn});if(C.isWebPage()){E.find(".top-menu-arrowdown").remove()}D.append(E)}}}m(A);e=A;j.getMainCnt().css({"min-width":D.width()+592+"px"})};var o=function(){var y=j.getMenuNav();j.getMenuCnt().on("mouseenter",function(A){var z=r.is(A.target,"li","#menu");if(z){u(z)}}).on("mousemove",function(A){var z=r.is(A.target,"li","#menu");if(z){u(z)}}).on("mouseleave",function(z){y.find("li.active").removeClass("active");g=null;l(false)}).on("click","li",function(){var z=$(this),B=z.attr("id"),A=v.findMenu(B);if(A&&A.isWebPage()&&A.isEnable()){d.add({menu:A})}});j.getLeftBtn().on("click","span",function(z){p(c,e-1)});j.getRightBtn().on("click","span",function(z){p(c,e+1)});j.getMenuPanel().on("click","a",function(z){var B=$(this).attr("id"),A=v.findMenu(B);if(A){if(A.isWebPage()){if(A.isEnable()){d.add({menu:A})}}else{q(A)}}}).on("click","h5 span",function(A){var z=$(this);if(z.hasClass("click")){var C=z.attr("id"),B=v.findMenu(C);if(B){if(B.isWebPage()){if(B.isEnable()){d.add({menu:B})}}else{q(B)}}}})};var q=function(C){var B=$("#"+C.getId()),D=r.is(B[0],".menu-level-2","#menu-panel");if(D){var y=D.find("h5").empty();var A=n(C);A.shift();$.each(A,function(E,G){var F=r.getTplDom(x.level2_title,{nameCn:G.nameCn,id:G.getId(),type:E==(A.length-1)?"current":"click",disabledclass:G.isDisabled()?"disabled":""});if(E>0){y.append(" - ")}y.append(F)});var z=D.find("[name=menu-level3-cnt]").empty();f(C.childs,z)}};var n=function(z,y){if(!y){y=[z]}else{y.push(z)}if(z.parent){return n(z.parent,y)}else{return y.reverse()}};var u=function(z){var A=j.getMenuNav();if(z){var B=z.attr("id"),y=v.findMenu(B);if(y!=g){A.find("li.active").removeClass("active");z.addClass("active");if(y.isWebPage()){z.addClass("active-page")}g=y;h(y,z)}}};var i=function(z){var y=z.position(),B=y.left,A=j.getMenuPanel().outerWidth();wWidth=$(window).width();if((B+A+k.margin_right)<=wWidth){return{left:B,radius:"right"}}else{var C=z.width();if((B+C/2+A/2+k.margin_right)<=wWidth){return{left:B+C/2-A/2,radius:"all"}}else{return{left:B+z.width()-A+2,radius:"left"}}}};var f=function(z,y){$.each(z,function(B,C){if(!C.isPermission()&&!C.isStoped()){var A=r.getTplDom(x.level3,{nameCn:C.nameCn,id:C.getId(),showSubIcon:(!C.isWebPage()&&C.hasChildNodes())?"":"hide",disabledclass:C.isDisabled()?"disabled":""});y.append(A)}})};var h=function(C,y){var z=j.getMenuPanel(),A=C.childs;z.empty();if(A&&A.length&&!C.isWebPage()){var B=i(y);$.each(A,function(E,H){if(!H.isPermission()&&!H.isStoped()){var F=r.getTplDom(x.level2);var G=F.find("[name=menu-level3-cnt]");f(H.childs,G);var D=F.find("h5");D.append(r.getTplDom(x.level2_title,{nameCn:H.nameCn,id:H.getId(),type:H.isWebPage()?"click":"current",disabledclass:H.isDisabled()?"disabled":""}));z.append(F)}});z.removeClass("menu-panel-radius-left");z.removeClass("menu-panel-radius-right");z.removeClass("menu-panel-radius-all");z.addClass("menu-panel-radius-"+B.radius);l(true);z.stop(true,true).animate({left:B.left},200)}else{l(false)}};var l=function(z){var y=j.getMenuPanel();if(z){y.show()}else{y.hide()}};var m=function(z){var A=c,B=j.getLeftBtn().find("span"),y=j.getRightBtn().find("span");if(A&&A.length&&A.length>s.menuNum){if(z==0){B.addClass("hide");y.removeClass("hide")}else{if((z+1)==Math.ceil(A.length/s.menuNum)){B.removeClass("hide");y.addClass("hide")}else{B.removeClass("hide");y.removeClass("hide")}}}else{B.addClass("hide");y.addClass("hide")}};b.init=function(){o();a(function(y){p(y,0)})};return b});