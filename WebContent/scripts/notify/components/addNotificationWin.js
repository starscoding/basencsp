Ext.Loader.setConfig({enabled:true});Ext.Loader.setPath("Ext.ux",extDir+"/ux");Ext.Loader.setPath("Ext.components","../../static/commonjs/components");var currentRecord=null;var currentId="";var refType="D";var submitRelType="";var status="0";var refIds=[];var required='<span style="color:red;font-weight:bold" data-qtip="Required">*</span>';Ext.define("Deparment",{extend:"Ext.data.Model",fields:[{name:"id",type:"string"},{name:"name",type:"string"},{name:"nameCn",type:"string"},{name:"order",type:"int"},{name:"desc",type:"string"},{name:"userNum",type:"int"},{name:"leaf",type:"boolean"},{name:"totalChildnum",type:"int"},{name:"text",type:"string"},{name:"disabled",type:"string"}]});Ext.define("Role",{extend:"Ext.data.Model",fields:[{name:"id",type:"string"},{name:"nameCn",type:"string"},{name:"checked",type:"string"}]});Ext.define("User",{extend:"Ext.data.Model",fields:[{name:"id",type:"string"},{name:"fullName",type:"string"},{name:"userName",type:"string"}]});function resetData(){currentRecord=null;currentId="";refType="D";submitRelType="";status="0";refIds=[]}function initRefSelectWin(){var e;var g;var b;var h;var i;var c;var f;var a;var d;e=Ext.create("Ext.data.TreeStore",{model:"Deparment",proxy:{type:"ajax",actionMethods:"POST",url:eastcom.baseURL+"/sysmng/notification/queryNotificationRefInfoByType",extraParams:{id:currentId,type:"D"}}});b=Ext.create("Ext.data.Store",{model:"Role",autoLoad:false,proxy:{type:"ajax",actionMethods:"POST",url:eastcom.baseURL+"/sysmng/notification/queryNotificationRefInfoByType",reader:{type:"json",root:"data"},extraParams:{id:currentId,type:"R"}},listeners:{load:function(k,j){refRoleGrid.getSelectionModel().selectAll();for(var l=0;l<j.length;l++){if(j[l].get("checked")!="true"){refRoleGrid.getSelectionModel().deselect(l)}}}}});c=Ext.create("Ext.data.Store",{model:"User",autoLoad:false,proxy:{type:"ajax",actionMethods:"POST",url:eastcom.baseURL+"/sysmng/notification/queryNotificationRefInfoByType",reader:{type:"json",root:"data"},extraParams:{id:currentId,type:"U"}}});i=Ext.create("Ext.data.Store",{model:"User",autoLoad:false,proxy:{type:"ajax",actionMethods:"POST",url:eastcom.baseURL+"/sysmng/security/queryUser",reader:{type:"json",root:"data.elements"}}});g=Ext.create("Ext.tree.Panel",{store:e,rootVisible:false,useArrows:true,border:false,setChildNode:function(m,l){var k;for(var j=0;j<m.length;j++){k=m[j];k.set("checked",l);if(k.childNodes.length>0){this.setChildNode(k.childNodes,l)}}},setParentNode:function(k,j){k.set("checked",j);if(k.parentNode!=null){this.setParentNode(k.parentNode,j)}},listeners:{checkchange:function(l,k,j){if(k){if(l.parentNode!=null){this.setParentNode(l.parentNode,k)}l.expand(true,function(){if(l.childNodes.length>0){this.setChildNode(l.childNodes,k)}},this)}else{if(l.childNodes.length>0){this.setChildNode(l.childNodes,k)}}}}});refRoleGrid=Ext.create("Ext.grid.Panel",{store:b,border:false,selModel:Ext.create("Ext.selection.CheckboxModel",{mode:"MULTI"}),columns:[{text:NOTIFY_ROLE_LIST,flex:1,sortable:false,dataIndex:"nameCn"}],listeners:{selectionchange:function(l,k,j){}}});f=Ext.create("Ext.panel.Panel",{layout:"border",region:"center",border:false,items:[Ext.create("Ext.grid.Panel",{id:"userList",store:i,title:NOTIFY_USER_LIST,width:150,region:"west",selModel:Ext.create("Ext.selection.CheckboxModel",{}),columns:[{text:USERNAME,flex:1,sortable:false,dataIndex:"userName",renderer:function(m,l,j){var o=m,k=j.get("fullName");if(k&&k.length){o+=("("+k+")")}return'<a title="'+o+'">'+o+"</a>"}}],listeners:{selectionchange:function(l,k,j){}}}),Ext.create("Ext.form.Panel",{region:"center",border:false,layout:{type:"anchor",padding:"5",pack:"center",align:"middle"},bodyStyle:{background:"#dfe8f6"},items:[{xtype:"button",text:"-->",margin:"70 2 10 2",anchor:"95%",handler:function(){var j=Ext.getCmp("userList").getSelectionModel().getSelection();Ext.getCmp("selectedUserList").getStore().loadData(j,true);Ext.getCmp("userList").getStore().remove(j)}},{xtype:"button",text:"<--",margin:"0 2 10 2",anchor:"95%",handler:function(){var j=Ext.getCmp("selectedUserList").getSelectionModel().getSelection();Ext.getCmp("selectedUserList").getStore().remove(j);Ext.getCmp("userList").getStore().loadData(j,true)}}]}),Ext.create("Ext.grid.Panel",{id:"selectedUserList",store:c,title:NOTIFY_USER_SELECTED,region:"east",width:150,selModel:Ext.create("Ext.selection.CheckboxModel",{mode:"MULTI"}),columns:[{text:USERNAME,flex:1,sortable:false,dataIndex:"userName",renderer:function(m,l,j){var o=m,k=j.get("fullName");if(k&&k.length){o+=("("+k+")")}return'<a title="'+o+'">'+o+"</a>"}}],listeners:{selectionchange:function(l,k,j){}}})]});a=Ext.create("Ext.panel.Panel",{layout:"border",border:false,items:[Ext.create("Ext.form.Panel",{layout:"hbox",region:"north",border:false,height:30,bodyStyle:{background:"#dfe8f6"},items:[{xtype:"textfield",fieldLabel:NAME,id:"username",margin:"5 5 5 5",labelWidth:30,flex:1,enableKeyEvents:true,emptyText:NOTIFY_USER_SEARCH_KEY_TEXT,listeners:{keypress:function(l,m,k){if(m.getKey()==13){var j=i.proxy;j.extraParams={input:l.getValue()};i.load()}}}},{margin:"5 5 5 0",xtype:"button",text:BUTTON_SEARCH,handler:function(){var j=i.proxy;j.extraParams={input:Ext.getCmp("username").getValue()};i.load()}}]}),f]});refTabPanel=Ext.create("Ext.tab.Panel",{activeTab:0,border:false,items:[{title:NOTIFY_DEPT,id:"D",layout:"fit",border:false,items:[g]},{title:NOTIFY_ROLE,id:"R",layout:"fit",border:false,items:[refRoleGrid]},{title:NOTIFY_USER,id:"U",layout:"fit",border:false,items:[a]}],buttons:[{text:BUTTON_OK,xtype:"button",handler:function(){var j=[];var k=[];if(refType=="D"){j=g.getChecked()}else{if(refType=="R"){j=refRoleGrid.getSelectionModel().getSelection()}else{if(refType=="U"){Ext.getCmp("selectedUserList").getStore().each(function(m){j=j.concat(m)})}}}if(refType=="D"){Ext.Array.each(j,function(m){if(m.get("leaf")==true){k=k.concat(m)}})}else{k=j}if(k.length>0){refIds=[];var l=refType=="U"?"fullName":"nameCn";if(k.length>1){Ext.getCmp("refSelecter").setValue(k[0].get(l)+"...("+k.length+NOTIFY_TARGETS_NUM)}else{Ext.getCmp("refSelecter").setValue(k[0].get(l))}Ext.Array.each(k,function(m){refIds.push(m.get("id"))});submitRelType=refType;d.close()}else{Ext.Msg.show({title:MSG_TITLE,msg:MSG_EMPTY_SELECTION,buttons:Ext.Msg.OK,icon:Ext.Msg.INFO})}}},{text:BUTTON_CANCEL,xtype:"button",handler:function(){Ext.getCmp("refSelectWin").close()}}],listeners:{tabchange:function(m,j,l,k){refType=j.getId();if(j.getId()=="R"){b.load()}else{if(j.getId()=="U"){i.load();c.load()}}refIds=[]}}});d=Ext.create("Ext.window.Window",{title:NOTIFY_TARGETS,height:300,id:"refSelectWin",width:350,layout:"fit",resizable:false,border:false,draggable:false,closable:false,items:[refTabPanel],listeners:{show:function(){Ext.getCmp("addNotificationWin").getEl().mask()},close:function(){Ext.getCmp("addNotificationWin").getEl().unmask()}}});d.setPosition(Ext.getCmp("addNotificationWin").getPosition()[0]+610,Ext.getCmp("addNotificationWin").getPosition()[1]);return d}Ext.define("Ext.notify.addNotificationWin",{extend:"Ext.window.Window",requires:["Ext.form.*","Ext.window.*","Ext.components.BaseDataComboBox","Ext.ux.RowExpander"],baseCommonData:null,title:BUTTON_NEW,id:"addNotificationWin",frame:false,layout:"fit",border:false,resizable:false,autoScroll:true,width:610,height:currentUserTheme=="neptune"?445:425,listeners:{show:function(){Ext.getBody().mask()},close:function(){Ext.getBody().unmask()},beforeclose:function(){var a=false;var b=Ext.getCmp("notifyAttPanel");var c=b.getChangesThisTime();if(c.del.length){Ext.Msg.show({title:MSG_TITLE,msg:NOTIFY_ATT_DELETED_MUST_SAVE,buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}else{if(c.add.length){Ext.Msg.show({title:MSG_TITLE,msg:NOTIFY_CLOSE_DEL_ATTACHMENT,buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,fn:function(f){if(f=="yes"){var g=function(){a=true;resetData();Ext.getCmp("addNotificationWin").close()};var d=[];for(var e=0;e<c.add.length;e++){d.push(c.add[e].realName)}b.deleteFile(d,g)}}})}else{a=true;resetData();if(Ext.getCmp("refSelectWin")){Ext.getCmp("refSelectWin").close()}}}return a},move:function(c,a,d,b){if(Ext.getCmp("refSelectWin")){Ext.getCmp("refSelectWin").setPosition(a+610,d)}}},initAddNotificationWinComponents:function(){resetData();var c;var b;var a;b=Ext.create("Ext.components.BaseDataComboBox",{parentName:"notificationType",id:"typeDivCombo",fieldLabel:NOTIFY_TYPE,allFlag:false,afterLabelTextTpl:required,emptyText:MSG_CHOOSE_ONE,anchor:"95%",value:"01"});a=Ext.create("Ext.components.BaseDataComboBox",{parentName:"notificationLevel",id:"levelCombo",fieldLabel:NOTITY_LEVEL,allFlag:false,afterLabelTextTpl:required,emptyText:MSG_CHOOSE_ONE,anchor:"100%",value:"2"});c=Ext.widget({xtype:"form",id:"addMainForm",region:"center",bodyStyle:{padding:"5px 5px 0px","overflow-x":"hidden","overflow-y":"auto"},fieldDefaults:{labelAlign:"top",msgTarget:"side"},items:[{xtype:"container",anchor:"100%",layout:"hbox",items:[{xtype:"container",flex:1,layout:"anchor",items:[{xtype:"textfield",fieldLabel:NOTIFY_TITLE,id:"notifyTitle",afterLabelTextTpl:required,emptyText:MSG_PLEASE_INSERT,allowBlank:false,anchor:"95%"},b,Ext.create("Ext.components.DateTimeField",{fieldLabel:NOTIFY_EFF_START_TIME,xtype:"datetimefield",id:"effectStartTime",endTimeField:{id:"effectEndTime"},timeConfig:{minDate:"%y-%M-%d"},emptyText:MSG_CHOOSE_ONE,allowBlank:false,afterLabelTextTpl:required,anchor:"95%"})]},{xtype:"container",flex:1,layout:"anchor",items:[{xtype:"textfield",fieldLabel:NOTIFY_PUBLISH_SCOPE,emptyText:MSG_CHOOSE_ONE,id:"refSelecter",afterLabelTextTpl:required,allowBlank:false,anchor:"100%",readOnly:true,listeners:{focus:function(){if(Ext.getCmp("initRefSelectWin")==null){initRefSelectWin().show()}},blur:function(){}}},a,Ext.create("Ext.components.DateTimeField",{fieldLabel:NOTIFY_EFF_END_TIME,xtype:"datetimefield",id:"effectEndTime",emptyText:MSG_CHOOSE_ONE,startTimeField:{id:"effectStartTime"},timeConfig:{minDate:"%y-%M-%d"},allowBlank:false,afterLabelTextTpl:required,anchor:"100%"})]}]},{xtype:"label",text:NOTIFY_ATTACHMENT+":"},Ext.create("Ext.components.CommonUploadPanel",{id:"notifyAttPanel",margin:"5 0 0 0",border:false,uploadConfig:{url:eastcom.baseURL+"/sysmng/notification/attachmentOperate",maskId:"addNotificationWin",callback:function(d){},params:{type:"upload"}},deleteConfig:{url:eastcom.baseURL+"/sysmng/notification/attachmentOperate",maskId:"addNotificationWin",callback:function(d){},params:{type:"delete"}}}),{xtype:"htmleditor",id:"content",fieldLabel:NOTIFY_CONTENT,height:160,anchor:"100%"}]});return c},loadNotification:function(a){var c=this;resetData();currentRecord=a;c.setTitle(BUTTON_EDIT);var b=c.baseCommonData;Ext.Ajax.request({url:eastcom.baseURL+"/sysmng/notification/queryNotificationWithRefInfo",method:"POST",params:{id:a.get("id")},success:function(f,k){var s=Ext.JSON.decode(f.responseText).data;var q=s.title;var p=s.type;var g=s.effectStartTime;var n=s.effectEndTime;var o=s.content;var h=s.file;var e=s.fileReal;var d=s.level;var r=s.status;switch(r){case b.status.using:status="1";break;case b.status.unPublished:status="0";break;case b.status.stopped:status="2";break}currentId=a.get("id");Ext.getCmp("notifyTitle").setValue(q);Ext.getCmp("effectStartTime").setValue(g);Ext.getCmp("effectEndTime").setValue(n);if(h!=null&&h.length>0&&e!=null&&e.length>0){names=h.split(",");realNames=e.split(",");var m=[];for(var l=0;l<names.length;l++){m.push({name:names[l],realName:realNames[l]})}Ext.getCmp("notifyAttPanel").loadData(m)}switch(p){case b.type.notificationMsg:Ext.getCmp("typeDivCombo").setValue("01");break;case b.type.warnMsg:Ext.getCmp("typeDivCombo").setValue("02");break;case b.type.announcementMsg:Ext.getCmp("typeDivCombo").setValue("03");break;case b.type.globalMsg:Ext.getCmp("typeDivCombo").setValue("04");break}Ext.getCmp("levelCombo").setValue(d);Ext.getCmp("content").setValue(o);var j="";Ext.Ajax.request({url:eastcom.baseURL+"/sysmng/notification/queryNotificationRefInfo",method:"POST",params:{id:a.get("id")},success:function(w,x){var t=Ext.JSON.decode(w.responseText);var u=t.data;for(var v in u){if(v==0){j+=u[v].name}else{j=j+","+u[v].name}refIds=refIds.concat(u[v].id)}submitRelType=u[0].type;Ext.getCmp("refSelecter").setValue(j)},failure:function(i,t){}})},failure:function(d,e){}})},initComponent:function(){var a=this;a.items=[a.initAddNotificationWinComponents()];a.buttons=[{text:BUTTON_OK,handler:function(){var e=Ext.getCmp("addMainForm").getForm();if(e.isValid()==true){if(Ext.getCmp("notifyAttPanel").isValid()){a.getEl().mask(MSG_DATA_SAVING);var j=Ext.getCmp("notifyTitle").getValue();var f=Ext.getCmp("effectStartTime").getValue();var g=Ext.getCmp("effectEndTime").getValue();var i=Ext.getCmp("typeDivCombo").getValue();var c=Ext.getCmp("levelCombo").getValue();var h=Ext.getCmp("content").getValue();var m=refIds.join(",");var b=Ext.getCmp("notifyAttPanel").currentNames;var l="";var k="";Ext.Array.each(b,function(o,n){if(n==0){l+=o.name}else{l=l+","+o.name}});Ext.Array.each(b,function(o,n){if(n==0){k+=o.realName}else{k=k+","+o.realName}});var d="0";if(currentId&&currentId.length){d="1"}Ext.Ajax.request({url:eastcom.baseURL+"/sysmng/notification/saveNotification?opt="+d,method:"POST",params:{id:currentId,title:j,effectStartTime:f,effectEndTime:g,type:i,file:l,fileUUID:k,relType:submitRelType,level:c,status:status,content:h,refIdsStr:m},success:function(p,q){var n=Ext.JSON.decode(p.responseText);if(n.success=="true"){if(currentRecord){currentRecord.set("title",j);currentRecord.set("type",Ext.getCmp("typeDivCombo").getRawValue());currentRecord.set("effectStartTime",f);currentRecord.set("effectEndTime",g);currentRecord.set("level",c)}else{var o=Ext.create("Notification",{id:n.data.id,title:j,type:Ext.getCmp("typeDivCombo").getRawValue(),effectStartTime:f,effectEndTime:g,level:c,status:a.baseCommonData.status.unPublished,publishTime:n.data.publishTime});Ext.getCmp("notifyGrid").switchToNormalMode();Ext.getCmp("notifyGrid").getStore().insert(0,o)}Ext.Msg.show({title:MSG_SUCCESS,msg:n.msg,buttons:Ext.Msg.OK,icon:Ext.Msg.INFO})}else{Ext.Msg.show({title:MSG_FAILURE,msg:n.msg,buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}Ext.getCmp("notifyAttPanel").doSave();a.getEl().unmask();a.close()},failure:function(o,p){var n=Ext.JSON.decode(o.responseText);Ext.Msg.show({title:MSG_FAILURE,msg:n.msg,buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}})}}else{Ext.Msg.show({title:MSG_TITLE,msg:MSG_ALL_CONDITIONS,buttons:Ext.Msg.OK,icon:Ext.Msg.INFO})}}},{text:BUTTON_CANCEL,handler:function(){Ext.getCmp("addNotificationWin").close()}}];this.callParent()}});