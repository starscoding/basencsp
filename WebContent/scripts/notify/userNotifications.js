Ext.Loader.setConfig({enabled:true});Ext.Loader.setPath("Ext.components","../../static/commonjs/components");Ext.Loader.setPath("Ext.notify","../../scripts/notify/components");Ext.Loader.setPath("Ext.ux",extDir+"/ux");Ext.require(["Ext.form.*","Ext.data.*","Ext.grid.*","Ext.tree.*","Ext.notify.showNotificationDetailPanel"]);eastcom.modules.userNotifications=(function(){var h=null;Ext.Ajax.request({url:eastcom.baseURL+"/sysmng/notification/queryConfigs",method:"POST",sync:false,params:{},success:function(i,A){h=Ext.JSON.decode(i.responseText)},failure:function(A,B){var i=Ext.JSON.decode(A.responseText);Ext.Msg.show({title:MSG_FAILURE,msg:MSG_FAILURE,buttons:Ext.Msg.ERROR,icon:Ext.Msg.ERROR})}});var w=[];var p=[];var x="unRead";var q="";Ext.define("Notification",{extend:"Ext.data.Model",fields:[{name:"id",type:"string"},{name:"title",type:"string"},{name:"type",type:"string"},{name:"publishTime",type:"string"},{name:"effectStartTime",type:"string"},{name:"effectEndTime",type:"string"},{name:"content",type:"string"},{name:"file",type:"string"},{name:"fileReal",type:"string"},{name:"level",type:"string"},{name:"status",type:"string"},{name:"read",type:"string"},{name:"groupTime",type:"string"},{name:"isDetele",type:"string"}]});Ext.define("NoData",{extend:"Ext.data.Model",fields:[{name:"noDataColumn",type:"string"}]});var l=Ext.create("Ext.data.Store",{model:"NoData",data:[{noDataColumn:MSG_EMPTYRSLT}]});var g=[{text:MSG_QUERYRSLT,sortable:false,dataIndex:"noDataColumn",flex:1,align:"center"}];var a=Ext.create("Ext.data.Store",{model:"Notification",autoLoad:true,groupField:"groupTime",pageSize:100,groupDir:"DESC",proxy:{type:"ajax",url:eastcom.baseURL+"/sysmng/notification/queryUserNotificationsFromORACLE",reader:{type:"json",root:"data"},extraParams:{readFlag:"unRead"},actionMethods:{read:"POST"},timeout:180000}});var k=Ext.create("Ext.grid.feature.Grouping",{groupHeaderTpl:"{name} ({rows.length})",hideGroupedHeader:true,enableNoGroups:true,startCollapsed:false,id:"restaurantGrouping"}),v=a.getGroups(),u=v.length,t=v.length,j=[],m=function(i){var A=i.text;if(i.checked){k.expand(A,true)}else{k.collapse(A,true)}};for(;t>0;t--){j[u-t]={xtype:"menucheckitem",text:v[t].name,handler:m}}sm=Ext.create("Ext.selection.CheckboxModel");var d=[{text:"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+NOTIFY_TITLE,flex:1,sortable:false,dataIndex:"title",renderer:s},{text:NOTIFY_TYPE,sortable:false,dataIndex:"type",width:120,align:"center",renderer:f},{text:NOTIFY_PUBLISH_TIME,dataIndex:"publishTime",width:160,align:"center",renderer:b}];var z=Ext.create("Ext.Action",{icon:"../../static/images/common/icons/removeAll.png",id:"addAction",text:BUTTON_DELETE,handler:function(C,B){var i=Ext.getCmp("notifyGrid").getSelectionModel().getSelection();var A=i[0].get("id");Ext.Ajax.request({url:eastcom.baseURL+"/sysmng/notification/userRemoveNotification",method:"POST",params:{idsStr:A},success:function(D,E){Ext.getCmp("notifyGrid").store.remove(i[0])},failure:function(E,F){var D=Ext.JSON.decode(E.responseText);Ext.Msg.show({title:MSG_FAILURE,msg:D.msg,buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}})}});var y=Ext.create("Ext.menu.Menu",{items:[z]});var e=Ext.create("Ext.ux.SimpleLiveSearchGridPanel",{id:"notifyGrid",requires:["Ext.grid.feature.Grouping"],useArrows:true,fit:true,border:true,store:a,features:[{ftype:"grouping",groupHeaderTpl:"{name} ({rows.length})",hideGroupedHeader:true,startCollapsed:true,id:"notifyGrouping"}],autoHeight:true,columns:d,columnLines:true,enableColumnHide:eastcom.enableColumnHide,tbar:[{xtype:"radiogroup",columns:4,vertical:true,listeners:{change:function(A,B){p=[];x=B.rb;var i=a.proxy;i.extraParams={readFlag:x};a.load()}},items:[{boxLabel:NOTIFY_UNREAD,name:"rb",width:60,inputValue:"unRead",checked:true},{boxLabel:NOTIFY_READ,name:"rb",width:50,inputValue:"read"},{boxLabel:NOTIFY_ALL,name:"rb",width:50,inputValue:"all"},{boxLabel:NOTIFY_DUSTBIN,width:70,name:"rb",inputValue:"delete"}]}],listeners:{select:function(C,i,A,B){n(i,A)},itemcontextmenu:function(i,D,B,A,C){C.stopEvent();if(x!="delete"){y.showAt(C.getXY())}return false},afterlayout:function(){for(var A=0;A<20;A++){$("#title"+A).addClass("unRead");$("#type"+A).addClass("unRead");$("#time"+A+"3").addClass("unRead");$("#time"+A+"4").addClass("unRead");$("#time"+A+"5").addClass("unRead")}}},animCollapse:false});var o=Ext.create("Ext.panel.Panel",{border:1,margin:"2 0 2 2",region:"west",split:true,border:false,width:"40%",minWidth:500,layout:"fit",items:[e]});var c=Ext.create("Ext.panel.Panel",{layout:"border",split:true,items:[o,Ext.create("Ext.notify.showNotificationDetailPanel",{region:"center",margin:"2 2 2 0",split:true})]});Date.prototype.format=function(A){var B={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};if(/(y+)/.test(A)){A=A.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))}for(var i in B){if(new RegExp("("+i+")").test(A)){A=A.replace(RegExp.$1,RegExp.$1.length==1?B[i]:("00"+B[i]).substr((""+B[i]).length))}}return A};function s(D,A,i,F){var E=i.get("level");var C=i.get("read");var B="";w=w.concat(i);if(E=="1"){if(C=="0"){B+="<a id='readIcon"+F+"'><img class='icon' alt='' class='icon' src='../../static/images/themes/blue/notification/mailb.png'></a>"}else{B+="<a id='readIcon"+F+"'><img class='icon' alt='' class='icon' src='../../static/images/themes/blue/notification/mailss.png'></a>"}B+="<a ";if(C=="0"){B+="id='title"+F+"' "}B+=" onClick='' class='notificationTitleTop'>"+D+"</a>"}else{if(C=="0"){B+="<a id='readIcon"+F+"'><img class='icon' alt='' src='../../static/images/themes/blue/notification/mailb.png'></a>"}else{B+="<a id='readIcon"+F+"'><img class='icon' alt='' src='../../static/images/themes/blue/notification/mailss.png'></a>"}B+="<a ";if(C=="0"){B+="id='title"+F+"' "}B+=" onClick='' class='notificationTitle'>"+D+"</a>"}return B}function n(i,A){var C=i.get("id");var B=i.get("read");if(!C&&!B){return false}if(B=="0"){$("#title"+A).removeClass("unRead");$("#type"+A).removeClass("unRead");$("#time"+A+"3").removeClass("unRead");$("#time"+A+"4").removeClass("unRead");$("#time"+A+"5").removeClass("unRead");document.getElementById("readIcon"+A).innerHTML="<img alt='' class='icon' src='../../static/images/themes/blue/notification/mailss.png'>";Ext.Ajax.request({url:eastcom.baseURL+"/sysmng/notificationLog/saveNocLog",method:"POST",params:{ids:C,viewTime:new Date().format("yyyy-MM-dd hh:mm:ss")},success:function(D,E){i.set("read","1")},failure:function(D,E){Ext.Msg.show({title:MSG_FAILURE,msg:MSG_FAILURE,buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}})}Ext.getCmp("showNotificationDetailPanel").updateContent(C)}function b(E,A,i,F,B){var D=i.get("read");var C="<a ";if(D=="0"){C+=" id='time"+F+""+B+"' "}C+="class='notificationTime'>"+E+"</a>";return C}function f(C,A,i,D){var B="";B+="<div>";if(C==h.type.notificationMsg){B+='<img alt="" class="icon" src="../../static/images/themes/blue/notification/notificationMsg2.gif">'}else{if(C==h.type.announcementMsg){B+='<img alt="" class="icon" src="../../static/images/themes/blue/notification/announcementMsg.gif">'}else{if(C==h.type.warnMsg){B+='<img alt="" class="icon" src="../../static/images/themes/blue/notification/warnMsg2.png">'}else{if(C==h.type.globalMsg){B+='<img alt="" class="icon" src="../../static/images/themes/blue/notification/warnMsg.png">'}}}}B+="<a class='notificationType'>"+C+"</a>";B+="</div>";return B}function r(){Ext.create("Ext.Viewport",{layout:{type:"fit",padding:5},items:[c]})}return{initComponent:r}})();