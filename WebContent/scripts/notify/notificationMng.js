Ext.Loader.setConfig({enabled:true});Ext.Loader.setPath("Ext.ux",extDir+"/ux");Ext.Loader.setPath("Ext.components","../../static/commonjs/components");Ext.Loader.setPath("Ext.notify","../../scripts/notify/components");Ext.require(["Ext.data.*","Ext.grid.*","Ext.tree.*","Ext.components.BaseDataComboBox","Ext.notify.addNotificationWin","Ext.notify.showNotificationDetailWin","Ext.notify.logWin"]);var nowPage=1;eastcom.modules.notificationMng=(function(){var l=null;Ext.Ajax.request({url:eastcom.baseURL+"/sysmng/notification/queryConfigs",method:"POST",sync:false,params:{},success:function(B,C){l=Ext.JSON.decode(B.responseText)},failure:function(C,D){var B=Ext.JSON.decode(C.responseText);Ext.Msg.show({title:MSG_FAILURE,msg:MSG_FAILURE,buttons:Ext.Msg.ERROR,icon:Ext.Msg.ERROR})}});var x=[];Ext.define("Notification",{extend:"Ext.data.Model",fields:[{name:"id",type:"string"},{name:"title",type:"string"},{name:"type",type:"string"},{name:"publishTime",type:"string"},{name:"effectStartTime",type:"string"},{name:"effectEndTime",type:"string"},{name:"level",type:"string"},{name:"status",type:"string"},{name:"stopFlag",type:"String"}]});Ext.define("NoData",{extend:"Ext.data.Model",fields:[{name:"noDataColumn",type:"string"}]});var n=Ext.create("Ext.data.Store",{model:"NoData",data:[{noDataColumn:MSG_EMPTYRSLT}]});var w=[{text:MSG_QUERYRSLT,sortable:false,dataIndex:"noDataColumn",flex:1,align:"center"}];var b=Ext.create("Ext.data.Store",{model:"Notification",pageSize:eastcom.pageSize,autoLoad:true,proxy:{type:"ajax",url:eastcom.baseURL+"/sysmng/notification/query",reader:{type:"json",root:"data.elements",totalProperty:"data.total"},extraParams:{allFlag:"true"},actionMethods:{read:"POST"},timeout:180000}});sm=Ext.create("Ext.selection.CheckboxModel");var h=[{text:NOTIFY_TITLE,flex:1,sortable:false,dataIndex:"title",minWidth:480,renderer:t},{text:NOTIFY_TYPE,sortable:false,dataIndex:"type",width:120,align:"center",renderer:k},{text:NOTIFY_PUBLISH_TIME,dataIndex:"publishTime",width:160,align:"center",renderer:f},{text:NOTIFY_EFF_START_TIME,dataIndex:"effectStartTime",width:160,align:"center",renderer:f},{text:NOTIFY_EFF_END_TIME,dataIndex:"effectEndTime",width:160,align:"center",renderer:f},{text:NOTIFY_STATUS,dataIndex:"status",width:80,align:"center",renderer:v}];var g=Ext.create("Ext.Action",{icon:"../../static/images/common/icons/new.png",id:"addAction",text:BUTTON_ADD,hidden:eastcom.isPermitted("sysNotificationmng","add"),handler:function(C,B){if(Ext.getCmp("addNotificationWin")==null){Ext.create("Ext.notify.addNotificationWin",{baseCommonData:l}).show()}else{Ext.Msg.show({title:MSG_TITLE,msg:NOTIFY_EDITWIN_EXSIST_MSG,buttons:Ext.Msg.OK,icon:Ext.Msg.INFO})}}});var y=Ext.create("Ext.Action",{icon:"../../static/images/common/icons/details-info.png",text:NOTIFY_DETAIL,disabled:true,handler:function(D,C){var B=Ext.getCmp("notifyGrid").getSelectionModel().getSelection();if(B.length>1){Ext.Msg.show({title:MSG_SURE,msg:NOTIFY_SELECT+B.length+NOTIFY_OPEN_ALL,buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,fn:function(F){if(F=="yes"){var G=[];for(var E=0;E<B.length;E++){G.push(B[E].get("id"))}o(G)}}})}else{o([B[0].get("id")])}}});var i=Ext.create("Ext.Action",{icon:"../../static/images/common/icons/teaching-plan.png",text:NOTIFY_VIEW_LOG,disabled:true,handler:function(D,C){var B=Ext.getCmp("notifyGrid").getSelectionModel().getSelection();if(B.length>1){Ext.Msg.show({title:MSG_TITLE,msg:NOTIFY_MUTIL_ERR_MSG,buttons:Ext.Msg.OK,icon:Ext.Msg.INFO})}else{Ext.create("Ext.notify.logWin",{notificationId:B[0].get("id"),title:NOTIFY_VIEW_LOG+": "+B[0].get("title")}).show()}}});var a=Ext.create("Ext.Action",{icon:"../../static/images/common/icons/edit.png",text:BUTTON_EDIT,hidden:eastcom.isPermitted("sysNotificationmng","edit"),disabled:true,handler:function(E,D){var C=Ext.getCmp("notifyGrid").getSelectionModel().getSelection();if(C.length>1){Ext.Msg.show({title:MSG_TITLE,msg:NOTIFY_MUTIL_ERR_MSG,buttons:Ext.Msg.OK,icon:Ext.Msg.INFO})}else{if(Ext.getCmp("addNotificationWin")==null){var B=Ext.create("Ext.notify.addNotificationWin",{baseCommonData:l});B.show(undefined,function(){B.loadNotification(C[0])})}else{Ext.Msg.show({title:MSG_TITLE,msg:NOTIFY_CALCEL_OPT,buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,fn:function(G){if(G=="yes"){Ext.getCmp("addNotificationWin").close();var F=Ext.create("Ext.notify.addNotificationWin",{baseCommonData:l});F.show(undefined,function(){F.loadNotification(C[0])})}}})}}}});var A=Ext.create("Ext.Action",{icon:"../../static/images/common/icons/delete.png",text:BUTTON_DELETE,hidden:eastcom.isPermitted("sysNotificationmng","delete"),disabled:true,handler:function(F,E){var B=Ext.getCmp("notifyGrid").getSelectionModel().getSelection();var C=B[0].get("id");for(var D=1;D<B.length;D++){C=C+","+B[D].get("id")}Ext.Msg.show({title:MSG_SURE,msg:DEL_BTN_INFO,buttons:Ext.Msg.YESNO,icon:Ext.Msg.WARNING,fn:function(G){if(G=="yes"){Ext.Ajax.request({url:eastcom.baseURL+"/sysmng/notification/removeNotifications",method:"POST",params:{idsStr:C},success:function(I,J){var H=Ext.JSON.decode(I.responseText);b.remove(B);Ext.Msg.show({title:MSG_SUCCESS,msg:H.msg,buttons:Ext.Msg.OK,icon:Ext.Msg.INFO})},failure:function(I,J){var H=Ext.JSON.decode(I.responseText);Ext.Msg.show({title:MSG_FAILURE,msg:H.msg,buttons:Ext.Msg.OK,icon:Ext.Msg.ERROR})}})}}})}});var u=Ext.create("Ext.Action",{icon:"../../static/images/common/icons/ok.png",text:NOTIFY_ENABLE,hidden:eastcom.isPermitted("sysNotificationmng","enable/disable"),disabled:true,handler:function(H,G){var B=Ext.getCmp("notifyGrid").getSelectionModel().getSelection();var F=[];for(var D=0;D<B.length;D++){var E=B[D].get("status");if(E==l.status.unPublished||E==l.status.stopped){F=F.concat(B[D])}}var C=F[0].get("id");for(var D=1;D<F.length;D++){C=C+","+F[D].get("id")}d(F,C,"1")}});var c=Ext.create("Ext.Action",{icon:"../../static/images/common/icons/no.png",text:NOTIFY_DISABLE,hidden:eastcom.isPermitted("sysNotificationmng","enable/disable"),disabled:true,handler:function(I,B){var F=Ext.getCmp("notifyGrid").getSelectionModel().getSelection();var G=[];var C=[];for(var H=0;H<F.length;H++){var K=F[H].get("status");if(K==l.status.using){if(F[H].get("stopFlag")=="true"){G=G.concat(F[H])}else{C=C.concat(F[H])}}}var E="";if(G.length>0){E=G[0].get("id");for(var H=1;H<G.length;H++){E=E+","+G[H].get("id")}}var D="";if(C.length>0){D=NOTIFY_ALREADY_START;D+=C[0].get("title").substr(0,4)+"...";for(var H=1;H<C.length;H++){var J=C[H].get("title").substr(0,4);D+=(","+J+"...")}}if(E.length>0){d(G,E,"2")}else{Ext.Msg.show({title:MSG_TITLE,msg:D,buttons:Ext.Msg.OK,icon:Ext.Msg.INFO})}}});function d(C,D,B){Ext.Ajax.request({url:eastcom.baseURL+"/sysmng/notification/changeStatus",method:"POST",params:{idsStr:D,status:B},success:function(H,I){var E=Ext.JSON.decode(H.responseText);var G=b.getProxy();G.extraParams={allFlag:"true"};for(var F=0;F<C.length;F++){C[F].set("status",B=="1"?l.status.using:l.status.stopped)}Ext.Msg.show({title:MSG_SUCCESS,msg:E.msg,buttons:Ext.Msg.OK,icon:Ext.Msg.INFO})},failure:function(F,G){var E=Ext.JSON.decode(F.responseText);Ext.Msg.show({title:MSG_FAILURE,msg:E.msg,buttons:Ext.Msg.ERROR,icon:Ext.Msg.INFO})}})}var z=Ext.create("Ext.menu.Menu",{items:[y,a,i,A,u,c]});var j=Ext.create("Ext.grid.Panel",{id:"notifyGrid",useArrows:true,fit:true,border:true,store:b,selModel:sm,autoHeight:true,columnLines:true,enableColumnHide:eastcom.enableColumnHide,columns:h,nomalStore:b,nomalColumns:h,noDataStore:n,noDataColumns:w,switchToNodataMode:function(){var B=this;if(B.store!=B.noDataStore){B.reconfigure(B.noDataStore,B.noDataColumns)}},switchToNormalMode:function(){var B=this;if(B.store!=B.nomalStore){B.reconfigure(B.nomalStore,B.nomalColumns)}},tbar:Ext.create("Ext.toolbar.Toolbar",{items:[g,"-",y,"-",i,"-",a,"-",A,"-",u,"-",c]}),bbar:Ext.create("Ext.components.BaseCommonPagingToolbar",{store:b,listeners:{change:function(D,C,B){if(C){nowPage=C.currentPage}}}}),listeners:{selectionchange:{fn:function(E,D,C){if(D.length>0&&D[0].get("id")&&D[0].get("id").length){if(y.isDisabled()){y.setDisabled(false)}if(a.isDisabled()){a.setDisabled(false)}if(i.isDisabled()){i.setDisabled(false)}if(A.isDisabled()){A.setDisabled(false)}var G=true;var F=true;for(var B=0;B<D.length;B++){if(D[B].get("status")=="未发布"||D[B].get("status")=="终止"){G=false}else{F=false}}u.setDisabled(G);c.setDisabled(F)}else{if(y.isDisabled()==false){y.setDisabled(true)}if(a.isDisabled()==false){a.setDisabled(true)}if(i.isDisabled()==false){i.setDisabled(true)}if(A.isDisabled()==false){A.setDisabled(true)}if(u.isDisabled()==false){u.setDisabled(true)}if(c.isDisabled()==false){c.setDisabled(true)}}}},itemcontextmenu:function(B,F,D,C,E){E.stopEvent();z.showAt(E.getXY());return false}},animCollapse:false});b.on("beforeload",function(){if(Ext.getBody()){Ext.getBody().mask(MSG_DATA_LOADING)}});b.on("load",function(){x=[];j.switchToNormalMode();if(b.getTotalCount()==0){j.switchToNodataMode()}Ext.getBody().unmask()});var m=Ext.create("Ext.components.BaseDataComboBox",{parentName:"notificationType",id:"typeCombo",fieldLabel:NOTIFY_TYPE,allFlag:true,labelAlign:"right",emptyText:MSG_CHOOSE_ONE,anchor:"100%",columnWidth:1/3,value:"_ALL_"});var e=Ext.create("Ext.form.Panel",{border:1,margin:"0 0 5 0",id:"queryPanel",region:"north",frame:false,frameHeader:false,items:[{xtype:"fieldcontainer",layout:{type:"hbox",pack:"start",padding:"5",align:"middle"},items:[{xtype:"textfield",id:"keyWords",fieldLabel:MSG_SEARCH_KEY,labelAlign:"right",border:false,padding:"5 10 0 10",anchor:"100%",labelWidth:80,width:500},{xtype:"splitter"},{xtype:"button",formBind:true,iconCls:"icon-search",text:BUTTON_SEARCH,width:70,handler:function(){r(false)}},{xtype:"splitter"},{xtype:"button",formBind:true,iconCls:"icon-refresh",text:BUTTON_RESET,width:70,handler:function(){Ext.getCmp("queryPanel").getForm().reset()}}]},{xtype:"fieldset",id:"moreCondition",checkboxToggle:true,collapsed:true,title:MSG_MORE_CONDITION,layout:"column",margin:5,padding:5,autoScroll:true,listeners:{expand:function(B){B.doLayout()}},items:[m,Ext.create("Ext.components.DateTimeField",{fieldLabel:LABEL_START_TIME,id:"publishStartTime",endTimeField:{id:"publishEndTime"},timeConfig:{maxDate:"%y-%M-%d"},anchor:"100%",labelAlign:"right",columnWidth:1/3}),Ext.create("Ext.components.DateTimeField",{id:"publishEndTime",startTimeField:{id:"publishStartTime"},timeConfig:{maxDate:"%y-%M-%d"},fieldLabel:LABEL_END_TIME,labelAlign:"right",anchor:"100%",columnWidth:1/3})]}]});var q=Ext.create("Ext.panel.Panel",{border:1,margin:"0 0 0 0",region:"center",border:false,layout:"fit",items:[j]});function t(F,C,B,H){var G=B.get("level");var E=B.get("read");var D="";x=x.concat(B);if(G=="1"){D+="<a ";if(E=="0"){D+="id='title"+H+"' "}D+=" onClick='' class='notificationTitleTop'>"+F+"&nbsp&nbsp</a>"}else{D+="<a ";if(E=="0"){D+="id='title"+H+"' "}D+=" onClick='' class='notificationTitle'>"+F+"&nbsp&nbsp</a>"}return D}function p(B){o(x[B])}function f(D,C,B,E){return"<a class='notificationTime'>"+D+"</a>"}function k(E,C,B,F){var D="";D+="<div>";if(E==l.type.notificationMsg){D+='<img alt="" class="icon" src="../../static/images/themes/blue/notification/notificationMsg2.gif">'}else{if(E==l.type.announcementMsg){D+='<img alt="" class="icon" src="../../static/images/themes/blue/notification/announcementMsg.gif">'}else{if(E==l.type.warnMsg){D+='<img alt="" class="icon" src="../../static/images/themes/blue/notification/warnMsg2.png">'}else{if(E==l.type.globalMsg){D+='<img alt="" class="icon" src="../../static/images/themes/blue/notification/warnMsg.png">'}}}}D+="<a class='notificationType'>"+E+"</a>";D+="</div>";return D}function v(D,C,B,E){if(D==l.status.unPublished){return"<a class='notificationStatus0'>"+D+"</a>"}else{if(D==l.status.using){return"<a class='notificationStatus1'>"+D+"</a>"}else{if(D==l.status.stopped){return"<a class='notificationStatus2'>"+D+"</a>"}}}}function r(B){var D=b.proxy;if(B){D.extraParams={allFlag:"true"}}else{var H=Ext.getCmp("moreCondition").collapsed;var G=Ext.getCmp("keyWords").getValue();var F=Ext.getCmp("typeCombo").getValue();var E=Ext.getCmp("publishStartTime").getValue();var C=Ext.getCmp("publishEndTime").getValue();if(H){if(G==""){D.extraParams={allFlag:"true"}}else{D.extraParams={allFlag:"false",keyWords:G}}}else{D.extraParams={allFlag:"false",keyWords:G,type:F,startTime:E,endTime:C}}}j.switchToNormalMode();b.loadPage(1,{start:0,limit:eastcom.pageSize})}function o(B){if(Ext.getCmp("showNotificationDetailWin")){Ext.getCmp("showNotificationDetailWin").ids=B;Ext.getCmp("showNotificationDetailWin").setData()}else{Ext.create("Ext.notify.showNotificationDetailWin",{ids:B}).show()}}function s(){Ext.create("Ext.Viewport",{layout:{type:"border",padding:5},items:[e,q]})}return{initComponent:s,gotoShowDetail:p}})();