define(["./utils","./config","./menuitem","./tab","./registerEastcom","text!./template/menu.html"],function(s,t,w,d,x,u){var b={},c=[],g=null,e=0,j={getMainCnt:function(){return $("#main-cnt")},getMenuCnt:function(){return $("#menu")},getMenuNav:function(){return $("#nav")},getMenuPanel:function(){return $("#menu-panel")},getLeftBtn:function(){return $("#menu-left-narrow")},getRightBtn:function(){return $("#menu-right-narrow")}},k={margin_right:65},y={nav:$(u).find("#top-menu-tpl").html(),level2:$(u).find("#menu-level2-tpl").html(),level2_title:$(u).find("#menu-level2-title-inner-tpl").html(),level3:$(u).find("#menu-level3-tpl").html()};var a=function(z){$.ajax({type:"POST",url:eastcom.baseURL+"/loginExtension/getCurrentUserTreeResources",dataType:"json",data:{rootMenuName:t.rootMenuName,controlStatus:t.controlStatus},success:function(B){if(s.validateAjaxRs(B,"用户菜单加载失败")){if(s.isNotBlank(t.rootMenuName)){if(B.data[0]){var A=w.create(B.data[0]);c=A.childs}}else{$.each(B.data,function(D,E){var C=w.create(E);c.push(C)})}z(c);x.initPermissionData(c)}}})};var r=function(z){d.add({menu:z,toMainPage:t.theme=="blue"})};var p=function(C,B){var E=j.getMenuNav().empty(),G=B*t.menuNum,z=(B+1)*t.menuNum;if(C&&C.length){if(z>C.length){z=C.length}for(var A=G;A<z;A++){var D=C[A];if(D.isMenu()&&!D.isStoped()){var F=s.getTplDom(y.nav,{id:D.getId(),nameCn:D.nameCn});if(D.isWebPage()){F.find(".top-menu-arrowdown").remove()}E.append(F)}}}m(B);e=B;j.getMainCnt().css({"min-width":E.width()+592+"px"})};var o=function(){var z=j.getMenuNav();j.getMenuCnt().on("mouseenter",function(B){var A=s.is(B.target,"li","#menu");if(A){v(A)}}).on("mousemove",function(B){var A=s.is(B.target,"li","#menu");if(A){v(A)}}).on("mouseleave",function(A){z.find("li.active").removeClass("active");g=null;l(false)}).on("click","li",function(){var A=$(this),C=A.attr("id"),B=w.findMenu(C);if(B&&B.isWebPage()&&B.isEnable()){r(B)}});j.getLeftBtn().on("click","span",function(A){p(c,e-1)});j.getRightBtn().on("click","span",function(A){p(c,e+1)});j.getMenuPanel().on("click","a",function(A){var C=$(this).attr("id"),B=w.findMenu(C);if(B){if(B.isWebPage()){if(B.isEnable()){r(B)}}else{q(B)}}}).on("click","h5 span",function(B){var A=$(this);if(A.hasClass("click")){var D=A.attr("id"),C=w.findMenu(D);if(C){if(C.isWebPage()){if(C.isEnable()){r(C)}}else{q(C)}}}})};var q=function(D){var C=$("#"+D.getId()),E=s.is(C[0],".menu-level-2","#menu-panel");if(E){var z=E.find("h5").empty();var B=n(D);B.shift();$.each(B,function(F,H){var G=s.getTplDom(y.level2_title,{nameCn:H.nameCn,id:H.getId(),type:F==(B.length-1)?"current":"click",disabledclass:H.isDisabled()?"disabled":""});if(F>0){z.append(" - ")}z.append(G)});var A=E.find("[name=menu-level3-cnt]").empty();f(D.childs,A)}};var n=function(A,z){if(!z){z=[A]}else{z.push(A)}if(A.parent){return n(A.parent,z)}else{return z.reverse()}};var v=function(A){var B=j.getMenuNav();if(A){var C=A.attr("id"),z=w.findMenu(C);if(z!=g){B.find("li.active").removeClass("active");A.addClass("active");if(z.isWebPage()){A.addClass("active-page")}g=z;h(z,A)}}};var i=function(A){var z=A.position(),C=z.left,B=j.getMenuPanel().outerWidth();wWidth=$(window).width();if((C+B+k.margin_right)<=wWidth){return{left:C,radius:"right"}}else{var D=A.width();if((C+D/2+B/2+k.margin_right)<=wWidth){return{left:C+D/2-B/2,radius:"all"}}else{return{left:C+A.width()-B+2,radius:"left"}}}};var f=function(A,z){$.each(A,function(C,D){if(!D.isPermission()&&!D.isStoped()){var B=s.getTplDom(y.level3,{nameCn:D.nameCn,id:D.getId(),disabledclass:D.isDisabled()?"disabled":""});z.append(B)}})};var h=function(D,z){var A=j.getMenuPanel(),B=D.childs;A.empty();if(B&&B.length&&!D.isWebPage()){var C=i(z);$.each(B,function(F,I){if(!I.isPermission()&&!I.isStoped()){var G=s.getTplDom(y.level2);var H=G.find("[name=menu-level3-cnt]");f(I.childs,H);var E=G.find("h5");E.append(s.getTplDom(y.level2_title,{nameCn:I.nameCn,id:I.getId(),type:I.isWebPage()?"click":"current",disabledclass:I.isDisabled()?"disabled":""}));A.append(G)}});A.removeClass("menu-panel-radius-left");A.removeClass("menu-panel-radius-right");A.removeClass("menu-panel-radius-all");A.addClass("menu-panel-radius-"+C.radius);l(true);A.stop(true,true).animate({left:C.left},200)}else{l(false)}};var l=function(A){var z=j.getMenuPanel();if(A){z.show()}else{z.hide()}};var m=function(A){var B=c,C=j.getLeftBtn().find("span"),z=j.getRightBtn().find("span");if(B&&B.length&&B.length>t.menuNum){if(A==0){C.addClass("hide");z.removeClass("hide")}else{if((A+1)==Math.ceil(B.length/t.menuNum)){C.removeClass("hide");z.addClass("hide")}else{C.removeClass("hide");z.removeClass("hide")}}}else{C.addClass("hide");z.addClass("hide")}};b.init=function(){o();a(function(z){p(z,0)})};return b});