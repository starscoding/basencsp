define(["./utils","./tabitem","./menuitem","./config","text!./template/tab.html"],function(q,l,u,r,t){var m=true,e,j=10,i=[],s=null,k=null,b={},c={getTabsRow:function(){return $("#tabs-row")},getTabsCnt:function(){return $("#tabs")},getIframeCnt:function(){return $("#tabs-iframe-cnt")},getLogo:function(){return $("#logo")}},v={tab:$(t).find("#lv1-tab-tpl").html(),subtab:$(t).find("#lv2-tab-tpl").html(),subul:$(t).find("#sub-ul-tpl").html(),backLi:$(t).find("#back-li").html()},g={id:"index",image:null,isShowDesktop:"0",isWebpage:"1",kind:"0",location:"/pages/globalview/leaderShipViewNew.jsp",name:"index",nameCn:"门户",order:0,pid:"",status:"1",childs:[]},p;l.setCallback("show",function(w){k=w});var a=function(w){var y=/^(http:\/\/)/i,x=/^(https:\/\/)/i;return y.exec(w)||x.exec(w)};var d=function(w){return a(w)?w:(eastcom.baseURL+w)};var n=function(){var x;for(x=0;x<i.length;x++){var w=i[x];if(w.destroyable()){w.destroy();break}}i.splice(x,1)};var h=function(){var w=[];$.ajax({type:"POST",url:eastcom.baseURL+"/loginExtension/getCurrentUserTreeResources",dataType:"json",data:{rootMenuName:r.tabRootMenu,controlStatus:false},success:function(y){if(q.validateAjaxRs(y,"用户菜单加载失败")){if(q.isNotBlank(r.tabRootMenu)){if(y.data[0]){var x=u.create(y.data[0]);w=x.childs}}else{$.each(y.data,function(A,B){var z=u.create(B);w.push(z)})}o(w)}}})};var o=function(w){var y=c.getTabsCnt(),x;x=function(B,A){var z,D=A?v.tab:v.subtab;if(B.childs&&B.childs.length&&!B.isWebPage()){z=q.getTplDom(D,{id:B.getId(),display:"",isShow:"",nameCn:B.nameCn});var C=q.getTplDom(v.subul,{});$.each(B.childs,function(G,F){var E=x(F);C.append(E)});z.append(C)}else{if(B.childs&&!B.isWebPage()){z=q.getTplDom(D,{id:B.getId(),display:"hide",isShow:"hide",nameCn:B.nameCn})}else{z=q.getTplDom(D,{id:B.getId(),display:"",isShow:"hide",nameCn:B.nameCn})}}return z};$.each(w,function(B,A){var z=x(A,true);y.append(z)});y.append(q.getTplDom(v.backLi))};b.close=function(w){if(!w||!w.length){w=k._menu.id}$.each(i,function(y,x){if(x.matchId(w)){x.destroy();i.splice(y,1);return false}})};b.getCurrent=function(){return k};b.getTab=function(w){var x;$.each(i,function(z,y){if(y.matchId(w)){x=y;return false}});return x};b.add=function(x){var C=x.menu,B=x.forceRefresh,y=x.closable,w=false;C.location=d(C.location);if(C.location.indexOf("target=newWindow")!=-1){window.open(C.location);return}if(C.location.indexOf("target=self")!=-1){window.location.href=C.location;return}if(x.toMainPage){window.location.href=eastcom.baseURL+r.mainPage+"?menu="+C.id}$("#fakeiframe").remove();var z=$("<div></div>");var A=c.getIframeCnt();if(m){$.each(i,function(F,E){if(E.matchId(C.id)){if(E.isDestroyed()){i.splice(F,1)}else{w=true;if(B){E.setLocation(C.location)}E.show();k=E}return false}});if(!w){if(i.length>=j){n()}var D=l.create(C,{previousTab:k,closable:y,destroyable:x.destroyable});D.render(z,A);D.show();k=D;i.push(D)}s=C}else{if(i[0]&&i[0].matchId(C.id)){if(B){i[0].setLocation(C.location);s=C}}else{z.empty();if(k){k.destroy()}var D=l.create(C);D.render(z,A);D.show();s=C;k=D;i=[D]}}};var f=function(){c.getLogo().on("click",function(){c.getTabsCnt().children("li").removeClass("sel");b.add({menu:e,destroyable:false})});c.getTabsCnt().on("mouseenter","li",function(){$(this).addClass("active")}).on("mouseleave","li",function(){$(this).removeClass("active")}).on("click","li",function(){var y=this.id,w=u.findMenu(y);if(y=="back-li"){window.location.href=eastcom.baseURL+r.mainPage}else{if(w.isWebPage()){var x=c.getTabsCnt().children("li.active");c.getTabsCnt().children("li").removeClass("sel");x.addClass("sel");b.add({menu:w})}}})};b.init=function(){j=r.tabMaxNum*1;if(r.showTabBar==true){h();c.getTabsRow().removeClass("hide")}f();g=$.extend(g,{location:r.defaultPageLocation,nameCn:r.defaultPageName});e=u.create(g);this.add({menu:e,destroyable:false})};return b});