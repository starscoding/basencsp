var AppIcon=function(p){var G=this;var o=null;var c="app";var d=eastcom.baseURL+"/static/images/common/appicons/";var x=null;var b=null;var F=null;var e=null;var k=null;var D=null;var m={width:390,height:375,appNumPerLine:3,appLineNumPerPage:3};var j=function(K){var H=$('<li class="block"></li>');var M=$('<div class="appDiv"></div>');K.imageUrl=K.imageUrl||(d+(K.image!=undefined&&K.image!=""?K.image:"bigdefault.png"));M.attr("title",K.nameCn);var J=$('<div class="img"></div>');J.css({"background-image":'url("'+K.imageUrl+'")'});var I=$('<a class="icon-text" href="javascript: void(0)"></a>');var L=$("<span></span>").text(K.nameCn);M.append(J).append(I.append(L));H.append(M);return H};var w=function(){var I;p.dragType=p.dragType||"outer";if(p.isFloder==true||p.isFloder=="true"){if(!p.items){p.items=[]}c="floder";p.imageUrl=eastcom.baseURL+"/static/images/themes/"+eastcom.getTheme()+"/desktop/floderIcon.png";if(p.newFloder){var H={nameCn:"文件夹"};p=$.extend(p,H)}I=j(p);a(p.items,I);i(p.items,I);z(I);if(p.newFloder){s();p.newFloder=false}}else{if(e){e.close()}c="app";I=j(p)}l(I);if(x){x.empty();x.append(I.children())}else{x=I}x.data("appIcon",G)};var z=function(){var I=eastcom.baseURL+"/static/images/themes/blue/desktop/trash_small.png";var H=eastcom.baseURL+"/static/images/themes/blue/desktop/trash_small_hover.png";b=$('<img class="trashSmall" src="'+I+'"></img>');e.getBody().append(b);F=$('<a class="">'+BUTTON_DELETE+"</a>");F.css({display:"none","font-size":"13px",position:"absolute",color:"white","font-weight":"bold",bottom:15,right:50});e.getBody().append(F);b.droppable({scope:"inner",over:function(){F.hide()},out:function(){F.show()},tolerance:"pointer",drop:function(J,K){var L=function(){b.attr("src",I);K.draggable.remove()};K.draggable.hide();u(K.draggable.data("appIcon"),L)}})};var u=function(H,I){$.ajax({type:"POST",dataType:"json",data:{drId:H.getData().drId},url:eastcom.baseURL+"/desktop/deleteIconFromDesktop",success:function(J){if(J.success=="true"){B();y(p.items,e.getBody().find(".iconContainer"));i(p.items,x);if(typeof(I)=="function"){I()}}}})};var l=function(I){I.hover(function(){$("li.block .icon-text span.spanHover").removeClass("spanHover");$(this).find(".icon-text span").addClass("spanHover")},function(){$(this).find(".icon-text span").removeClass("spanHover")});I.bind("click",function(){if(c=="app"){C()}else{if(c=="floder"&&e){s()}}});I.draggable({start:function(){G.getParent().getTrash().show();if(G.getParent().getTrashMsg&&G.getParent().getTrashMsg()){G.getParent().getTrashMsg().show()}$(this).children().hide()},stop:function(){G.getParent().getTrash().hide();if(G.getParent().getTrashMsg&&G.getParent().getTrashMsg()){G.getParent().getTrashMsg().hide()}$(this).children().show()},scope:p.dragType,distance:10,scroll:false,helper:"clone",revert:"invalid"});var H;I.droppable({scope:p.dragType,over:function(J,K){I.data("mouseOn",true);H=setTimeout(function(){if(I.data("mouseOn")){var L=K.draggable.data("appIcon");if(G.isApp()&&L.isApp()&&L.getData().dragType=="outer"){I.data("unExchange",true);E(K.draggable);g(L)}else{if(G.isFloder()&&L.isApp()){I.data("unExchange",true);G.getParent().getTrash().hide();E(K.draggable);v(L)}}}},1000)},out:function(J,K){$(this).data("mouseOn",false);if(H){clearTimeout(H)}},drop:function(L,M){if(H){clearTimeout(H)}if($(this).data("unExchange")){$(this).data("unExchange",false);if(D){n(D,function(){D=null})}return false}else{var K=p;var N=$(M.draggable).data("appIcon"),J=N.getData();f(J);N.refresh(K);if(o){o.sort()}}}})};var i=function(H,I){var K=$('<div class="smallIconDiv"></div>');$.each(H,function(M,N){N.dragType="inner";if(M<m.appLineNumPerPage*m.appNumPerLine){var L=($('<img class="smallIcon" src="'+N.imageUrl+'"></img>'));K.append(L)}});var J=I.find("div.img");J.empty();J.append(K)};var r=function(N){var N=$('<a name="deskFloderTitle"></a>');var O=$('<a class="floderName">'+p.nameCn+"</a>");var I=$('<input class="renameInput" type="text" value="'+p.nameCn+'"/>');var L=eastcom.baseURL+"/static/images/common/icons/edit.png";var M=eastcom.baseURL+"/static/images/common/icons/ok.png";var K=eastcom.baseURL+"/static/images/common/icons/no.png";var J=$('<img class="editIcon optIcon" title="'+BUTTON_UPDATE+'" src = "'+L+'"></img>');var H=$('<img class="cancelIcon optIcon" title="'+BUTTON_CANCEL+'" src = "'+K+'"></img>').hide();N.append(O);N.append(I);N.append(J);N.append(H);J.bind("click",function(){if(J.data("editing")){q(false,true)}else{q(true)}});H.bind("click",function(){q(false,false)});return N};var q=function(N,I){var O=e.getTitleDom();var K=O.find(".floderName");var P=O.find(".renameInput");var J=O.find(".editIcon");var H=O.find(".cancelIcon");var M=eastcom.baseURL+"/static/images/common/icons/edit.png";var L=eastcom.baseURL+"/static/images/common/icons/ok.png";if(N){K.hide();P.css({display:"inline"});J.attr("src",L);J.attr("title",BUTTON_OK);J.data("editing",true);H.css({display:"inline"})}else{if(I){var Q=P.val();if(Q&&Q.length){$.ajax({type:"POST",url:eastcom.baseURL+"/desktop/floderOpts",dataType:"json",data:{type:"rename",data:$.toJSON({id:p.drId,name:Q})},success:function(R){if(R.success=="true"){p.nameCn=Q;p.floderName=Q;x.find(".icon-text span")[0].innerHTML=Q;K.empty();K.append(Q);P.css({display:"none"});H.css({display:"none"});K.show();H.hide();J.attr("src",M);J.attr("title",BUTTON_UPDATE);J.data("editing",false)}}})}else{alert(MSG_FIELD_NOTNULL)}}else{K.show();P.css({display:"none"});H.css({display:"none"});P.attr("value",K[0].innerHTML);J.attr("src",M);J.attr("title",BUTTON_UPDATE);J.data("editing",false)}}};var a=function(I,K){var J=$('<div class="control"></div>');J.append('<table align="center"><tbody><tr><td class="control-l"></td><td class="control-c"></td><td class="control-r"></td></tr></tbody></table>');if(e){e.close()}e=new CommonWindow({title:r(p.nameCn),width:m.width,height:m.height,dragable:false,titleAlign:"center",closeAction:"hide",closable:false,content:J,animationTarget:K.find("div.img")});var H=$('<div class="iconContainer"></div>');H.css({position:"absolute",width:e.getBody().width(),height:e.getBody().height(),left:0,top:0});e.getBody().append(H);e.getBody().css({overflow:"hidden"});y(I,H)};var y=function(I,H){H.empty();var L=e.getBody().find(".control .control-c");L.empty();var K=Math.ceil(I.length/m.appLineNumPerPage/m.appNumPerLine);k=H.slideBox({count:K,fullScreen:false,width:e.getBody().width(),height:e.getBody().height(),cancel:"*",obstacle:"200",touchDevice:false,control:L});var J=[];$.each(I,function(O,Q){var N=Math.floor(O/m.appLineNumPerPage/m.appNumPerLine);Q.dragType="inner";var P=new AppIcon(Q);P.setParent(G);if(J[N]==null){var M=$('<ul class="unPadding"></ul>');J[N]=M}J[N].append(P.getDom())});$.each(J,function(N,M){k.getScreen(N).append(M)})};var E=function(H){var I=$(".ui-draggable-dragging");var J=x.position();I.animate({left:J.left+30,top:J.top+30,width:0,height:0},200,"swing",function(){I.remove();H.trigger($.Event("mouseup"))})};var g=function(H){var J=function(M){var L;if(M.constructor==Object){L=new M.constructor()}else{L=new M.constructor(M.valueOf())}for(var K in M){if(L[K]!=M[K]){if(typeof(M[K])=="object"){L[K]=J(M[K])}else{L[K]=M[K]}}}L.toString=M.toString;L.valueOf=M.valueOf;return L};p.items=[J(G.getData()),H.getData()];D=H;p.newFloder=true;p.isFloder=true;w();var I={name:"文件夹",desktopId:p.deskId,drId1:p.drId,drId2:H.getData().drId,order:p.order};H.getDom().hide();$.ajax({type:"POST",url:eastcom.baseURL+"/desktop/floderOpts",dataType:"json",data:{type:"create",data:$.toJSON(I)},success:function(K){if(K.success=="true"){p.drId=K.data;H.getParent().sort();H.getParent().removeItem(H)}}})};var f=function(H){p=H;w()};var s=function(){e.setPosition(t());e.show(function(){$("body").one("click",A)})};var A=function(I){var H=t();if(I.clientX>H.left&&I.clientX<H.left+m.width&&I.clientY>H.top&&I.clientY<H.top+m.height){$("body").one("click",A)}else{if(k&&k.getCursor()!=0){k.scroll(0)}q(false,false);e.hide()}};var C=function(){eastcom.createTab(p.resId,p.nameCn,p.name,p.location)};var t=function(){var I=document.body.clientHeight;var L=document.body.clientWidth;var K=x.offset().left-(m.width-120)/2;var J=x.offset().top+65;var H=20;K=K<H?H:K;K=(K+m.width+H)>L?(L-m.width-H):K;J=(J+m.height+H)>I?(I-m.height-H):J;J=J<H?((I-2*H)<m.height?H:(I-m.height-H)):J;return{left:K,top:J}};var h=function(H){x.appendTo(H)};var v=function(O){var K=O.getData();var P=K.resId;var N=false;for(var I=0;I<p.items.length;I++){if(p.items[I].resId==P){N=true;break}}if(N){alert(eastcom.sprintf(PD_FLODER_EXSIST_APP,K.nameCn));return false}var L=Math.ceil((p.items.length+1)/m.appLineNumPerPage/m.appNumPerLine);var J;if(k.getCount()<L){k.addScreen();J=$('<ul class="unPadding"></ul>');k.getScreen(L-1).append(J)}else{J=k.getScreen(L-1).find("ul")}K.dragType="inner";var M=new AppIcon(K);M.setParent(G);J.append(M.getDom());p.items.push(K);i(p.items,x);D=O;var H={drId:K.drId,fId:p.drId,order:p.items.length-1};O.getDom().hide();$.ajax({type:"POST",url:eastcom.baseURL+"/desktop/floderOpts",dataType:"json",data:{type:"insert",data:$.toJSON(H)},success:function(Q){if(Q.success=="true"){O.getParent().sort();O.getParent().removeItem(O)}}})};var n=function(H,I){H.remove();H=null;if(typeof(I)=="function"){I()}};var B=function(){if(c=="floder"){var I=e.getBody().find("li.block:not(.ui-draggable-dragging)");var J=[];p.items=[];var H=0;$.each(I,function(L,K){if($(K).css("display")=="none"){setTimeout(function(){$(K).remove()},1000)}else{var N=$(K).data("appIcon");var M=N.getData();J.push(M.drId+":"+H);p.items.push(M);N.setOrder(H);H+=1}});$.ajax({type:"POST",url:eastcom.baseURL+"/desktop/sortUserDesktopIcons",dataType:"json",data:{desktopId:p.deskId,orders:J.join()},success:function(K){i(p.items,x)}})}};w();this.setContainer=h;this.getType=function(){return c};this.isFloder=function(){return c=="floder"};this.isApp=function(){return c=="app"};this.getData=function(){return p};this.getDom=function(){return x};this.setStyle=function(H){x.css(H)};this.remove=function(){x.css({display:"none"})};this.refresh=f;this.sort=B;this.setParent=function(H){o=H};this.setOrder=function(H){p.order=H};this.getParent=function(){return o};this.getTrash=function(){return b};this.getTrashMsg=function(){return F}};